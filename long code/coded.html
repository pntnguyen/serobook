<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tổng hợp code Long đã code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="coded_files/libs/clipboard/clipboard.min.js"></script>
<script src="coded_files/libs/quarto-html/quarto.js"></script>
<script src="coded_files/libs/quarto-html/popper.min.js"></script>
<script src="coded_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="coded_files/libs/quarto-html/anchor.min.js"></script>
<link href="coded_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="coded_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="coded_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="coded_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="coded_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tổng hợp code Long đã code</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="chapter-3.5.1" class="level2">
<h2 class="anchored" data-anchor-id="chapter-3.5.1">Chapter 3.5.1</h2>
<p><strong>Code in the book</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(serosv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>SIRtwo<span class="ot">=</span><span class="cf">function</span>(t,state,parameters)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ds1 <span class="ot">=</span> <span class="sc">-</span>(betatilde11<span class="sc">*</span>i1<span class="sc">+</span>betatilde12<span class="sc">*</span>i2)<span class="sc">*</span>s1<span class="sc">+</span>mu<span class="sc">-</span>mu<span class="sc">*</span>s1</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>di1 <span class="ot">=</span> (betatilde11<span class="sc">*</span>i1<span class="sc">+</span>betatilde12<span class="sc">*</span>i2)<span class="sc">*</span>s1<span class="sc">-</span>nu1<span class="sc">*</span>i1<span class="sc">-</span>mu<span class="sc">*</span>I1</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>dr1 <span class="ot">=</span> nu1<span class="sc">*</span>i1 <span class="sc">-</span> mu<span class="sc">*</span>r1</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>ds2 <span class="ot">=</span> <span class="sc">-</span>(betatilde21<span class="sc">*</span>i1<span class="sc">+</span>betatilde22<span class="sc">*</span>i2)<span class="sc">*</span>s2<span class="sc">+</span>mu<span class="sc">-</span>mu<span class="sc">*</span>s2</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>di2 <span class="ot">=</span> (betatilde21<span class="sc">*</span>i1<span class="sc">+</span>betatilde22<span class="sc">*</span>i2)<span class="sc">*</span>s2<span class="sc">-</span>nu2<span class="sc">*</span>i2<span class="sc">-</span>mu<span class="sc">*</span>i2</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dr2 <span class="ot">=</span> nu2<span class="sc">*</span>i2<span class="sc">-</span>mu<span class="sc">*</span>r2</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="fu">c</span>(ds1,di1,dr1,ds2,di2,dr2))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Long’s function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="cf">function</span>(state, parameters, i)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)), {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sum_beta_i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      sum_beta_i <span class="ot">&lt;-</span> sum_beta_i <span class="sc">+</span> beta[i,j]<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"i"</span>, j))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>sum_beta_i<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"s"</span>, i)) <span class="sc">+</span> mu <span class="sc">-</span> mu<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"s"</span>, i))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>di <span class="ot">&lt;-</span> <span class="cf">function</span>(state, parameters, i)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)), {</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    sum_beta_i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k) {</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      sum_beta_i <span class="ot">&lt;-</span> sum_beta_i <span class="sc">+</span> beta[i,j]<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"i"</span>, j))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    sum_beta_i<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"s"</span>, i)) <span class="sc">-</span> nu[i]<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"i"</span>, i)) <span class="sc">-</span> mu<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"i"</span>, i))</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>dr <span class="ot">&lt;-</span> <span class="cf">function</span>(state, parameters, i)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)), {</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    nu[i]<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"i"</span>, i)) <span class="sc">-</span> mu<span class="sc">*</span><span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">"r"</span>, i))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>sir_subpop <span class="ot">&lt;-</span> <span class="cf">function</span>(t, state, parameters) {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)), {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    s_states <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    i_states <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    r_states <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k) {</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>      s_states <span class="ot">&lt;-</span> <span class="fu">c</span>(s_states, <span class="fu">ds</span>(state, parameters, i))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      i_states <span class="ot">&lt;-</span> <span class="fu">c</span>(i_states, <span class="fu">di</span>(state, parameters, i))</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>      r_states <span class="ot">&lt;-</span> <span class="fu">c</span>(r_states, <span class="fu">dr</span>(state, parameters, i))</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(s_states, i_states, r_states))</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Run function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">2</span>                </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>state <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="at">s =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">i =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">r =</span> <span class="fu">c</span>(  <span class="dv">0</span>,   <span class="dv">0</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>beta_matrix <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.00</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="fu">c</span>(<span class="fl">0.00</span>, <span class="fl">0.05</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>   <span class="at">beta =</span> <span class="fu">matrix</span>(beta_matrix, <span class="at">nrow=</span>k, <span class="at">ncol=</span>k, <span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>   <span class="at">nu =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>   <span class="at">mu =</span> <span class="fl">0.001</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>   <span class="at">k =</span> k</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>times<span class="ot">&lt;-</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>,<span class="at">by=</span><span class="fl">0.5</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">sir_subpop</span>(times, state, parameters)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>sir_subpops_model <span class="ot">&lt;-</span> <span class="cf">function</span>(times, state, parameters) {</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ode</span>(<span class="at">y=</span>state,<span class="at">times=</span>times,<span class="at">func=</span>sir_subpop,<span class="at">parms=</span>parameters)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">sir_subpops_model</span>(times, state, parameters)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>out[out<span class="sc">$</span>time <span class="sc">==</span> <span class="st">"10000"</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       time        s1        s2          i1          i2        r1        r2
20001 10000 0.6869925 0.6869925 0.009141676 0.009141676 0.3038659 0.3038659</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>SIRtwo<span class="ot">=</span><span class="cf">function</span>(t,state,parameters)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(state, parameters)),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ds1 <span class="ot">=</span> <span class="sc">-</span>(betatilde11<span class="sc">*</span>i1<span class="sc">+</span>betatilde12<span class="sc">*</span>i2)<span class="sc">*</span>s1<span class="sc">+</span>mu<span class="sc">-</span>mu<span class="sc">*</span>s1</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>di1 <span class="ot">=</span> (betatilde11<span class="sc">*</span>i1<span class="sc">+</span>betatilde12<span class="sc">*</span>i2)<span class="sc">*</span>s1<span class="sc">-</span>nu1<span class="sc">*</span>i1<span class="sc">-</span>mu<span class="sc">*</span>i1</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>dr1 <span class="ot">=</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>nu1<span class="sc">*</span>i1 <span class="sc">-</span> mu<span class="sc">*</span>r1</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>ds2 <span class="ot">=</span> <span class="sc">-</span>(betatilde21<span class="sc">*</span>i1<span class="sc">+</span>betatilde22<span class="sc">*</span>i2)<span class="sc">*</span>s2<span class="sc">+</span>mu<span class="sc">-</span>mu<span class="sc">*</span>s2</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>di2 <span class="ot">=</span> (betatilde21<span class="sc">*</span>i1<span class="sc">+</span>betatilde22<span class="sc">*</span>i2)<span class="sc">*</span>s2<span class="sc">-</span>nu2<span class="sc">*</span>i2<span class="sc">-</span>mu<span class="sc">*</span>i2</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>dr2 <span class="ot">=</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>nu2<span class="sc">*</span>i2<span class="sc">-</span>mu<span class="sc">*</span>r2</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="fu">c</span>(ds1,di1,dr1,ds2,di2,dr2))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>parameters<span class="ot">=</span><span class="fu">c</span>(<span class="at">betatilde11=</span><span class="fl">0.05</span>,<span class="at">betatilde12=</span><span class="dv">0</span>,<span class="at">betatilde21=</span><span class="dv">0</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="at">betatilde22=</span><span class="fl">0.05</span>,<span class="at">nu1=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>,<span class="at">nu2=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>,<span class="at">mu=</span><span class="fl">0.001</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>state<span class="ot">=</span><span class="fu">c</span>(<span class="at">s1=</span><span class="fl">0.8</span>,<span class="at">i1=</span><span class="fl">0.2</span>,<span class="at">r1=</span><span class="dv">0</span>,<span class="at">s2=</span><span class="fl">0.8</span>,<span class="at">i2=</span><span class="fl">0.2</span>,<span class="at">r2=</span><span class="dv">0</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>times<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ode</span>(<span class="at">y=</span>state,<span class="at">times=</span>times,<span class="at">func=</span>SIRtwo,<span class="at">parms=</span>parameters)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  time        s1        i1           r1        s2        i2           r2
1 0.00 0.8000000 0.2000000 0.000000e+00 0.8000000 0.2000000 0.000000e+00
2 0.01 0.7999220 0.2000113 6.666822e-05 0.7999220 0.2000113 6.666822e-05
3 0.02 0.7998440 0.2000227 1.333396e-04 0.7998440 0.2000227 1.333396e-04
4 0.03 0.7997660 0.2000340 2.000140e-04 0.7997660 0.2000340 2.000140e-04
5 0.04 0.7996880 0.2000453 2.666915e-04 0.7996880 0.2000453 2.666915e-04
6 0.05 0.7996101 0.2000566 3.333722e-04 0.7996101 0.2000566 3.333722e-04</code></pre>
</div>
</div>
<p><strong>explain function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sub population = 2 =&gt; k =2</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>i <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>beta_matrix <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.00</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">c</span>(<span class="fl">0.00</span>, <span class="fl">0.05</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="fu">matrix</span>(beta_matrix, <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>beta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,] 0.05 0.00
[2,] 0.00 0.05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>beta[<span class="dv">1</span>,<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">"i"</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "i1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>s_state <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">ds</span>(state, parameters, <span class="dv">1</span>),<span class="fu">ds</span>(state, parameters, <span class="dv">2</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>s_state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.0078 -0.0078</code></pre>
</div>
</div>
<p><strong>test function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"sir_subpops_model returns expected results"</span>, {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">time=</span><span class="dv">10000</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">s1=</span><span class="fl">0.6869925</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">s2=</span><span class="fl">0.6869925</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">i1=</span><span class="fl">0.009141676</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">i2=</span><span class="fl">0.009141676</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">r1=</span><span class="fl">0.3038659</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">r2=</span><span class="fl">0.3038659</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">s =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">r =</span> <span class="fu">c</span>(  <span class="dv">0</span>,   <span class="dv">0</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  beta_matrix <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.00</span>),</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fl">0.00</span>, <span class="fl">0.05</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">matrix</span>(beta_matrix, <span class="at">nrow=</span>k, <span class="at">ncol=</span>k, <span class="at">byrow=</span><span class="cn">TRUE</span>),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">30</span>),</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> <span class="fl">0.001</span>,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> k</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  times<span class="ot">&lt;-</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">10000</span>,<span class="at">by=</span><span class="dv">10</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">sir_subpops_model</span>(times, state, parameters)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">tail</span>(output, <span class="dv">1</span>))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance =</span> <span class="fl">0.000001</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 😸</code></pre>
</div>
</div>
</section>
<section id="chapter-6.1.1" class="level2">
<h2 class="anchored" data-anchor-id="chapter-6.1.1">Chapter 6.1.1</h2>
<p>Polynomial model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="cf">function</span>(t, degree) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  X_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(t)), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (degree <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>degree) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      X_matrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X_matrix, i <span class="sc">*</span> t<span class="sc">^</span>(i<span class="dv">-1</span>))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>X_matrix</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>predictor <span class="ot">&lt;-</span> <span class="cf">function</span>(degree) {</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="st">"cbind(tot-pos, pos)~-1"</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>degree) {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">paste0</span>(formula, <span class="st">"+I(age^"</span>, i, <span class="st">")"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  formula</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="fu">predictor</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cbind(tot-pos, pos)~-1+I(age^1)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## trong sách là cbind(tot-pos, pos)~-1+age</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>polynomial_model <span class="ot">&lt;-</span> <span class="cf">function</span>(age, pos, tot, <span class="at">deg=</span><span class="dv">1</span>) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">predictor</span>(deg)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(f),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"log"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">X</span>(age, deg)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> X<span class="sc">%*%</span>model<span class="sc">$</span>info<span class="sc">$</span>coefficients</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot=</span>tot)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"polynomial_model"</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>polymodel <span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(a<span class="sc">$</span>age,a<span class="sc">$</span>pos,a<span class="sc">$</span>tot, <span class="at">deg =</span> <span class="dv">3</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(polymodel<span class="sc">$</span>info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 30
 $ coefficients     : Named num [1:3] -5.33e-02 5.07e-04 -1.02e-05
  ..- attr(*, "names")= chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
 $ residuals        : Named num [1:83] -0.1435 -0.1118 -0.0508 -0.1497 -0.4624 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ fitted.values    : Named num [1:83] 0.949 0.901 0.856 0.814 0.775 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ effects          : Named num [1:83] 19.78 -1.17 1.11 -0.79 -2.62 ...
  ..- attr(*, "names")= chr [1:83] "I(age^1)" "I(age^2)" "I(age^3)" "" ...
 $ R                : num [1:3, 1:3] -398 0 0 -12287 6030 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  .. ..$ : chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
 $ rank             : int 3
 $ qr               :List of 5
  ..$ qr   : num [1:83, 1:3] -398.1747 0.0586 0.0735 0.0758 0.0807 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:83] "1" "2" "3" "4" ...
  .. .. ..$ : chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  ..$ rank : int 3
  ..$ qraux: num [1:3] 1.04 1.11 1.17
  ..$ pivot: int [1:3] 1 2 3
  ..$ tol  : num 1e-11
  ..- attr(*, "class")= chr "qr"
 $ family           :List of 13
  ..$ family    : chr "binomial"
  ..$ link      : chr "log"
  ..$ linkfun   :function (mu)  
  ..$ linkinv   :function (eta)  
  ..$ variance  :function (mu)  
  ..$ dev.resids:function (y, mu, wt)  
  ..$ aic       :function (y, n, mu, wt, dev)  
  ..$ mu.eta    :function (eta)  
  ..$ initialize: language {     if (NCOL(y) == 1) { ...
  ..$ validmu   :function (mu)  
  ..$ valideta  :function (eta)  
  ..$ simulate  :function (object, nsim)  
  ..$ dispersion: num 1
  ..- attr(*, "class")= chr "family"
 $ linear.predictors: Named num [1:83] -0.0528 -0.1046 -0.1555 -0.2056 -0.2549 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ deviance         : num 93.8
 $ aic              : num 220
 $ null.deviance    : num Inf
 $ iter             : int 8
 $ weights          : Named num [1:83] 295.3 136.1 95.1 57 41.3 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ prior.weights    : Named num [1:83] 16 15 16 13 12 15 12 11 10 15 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ df.residual      : int 80
 $ df.null          : int 83
 $ y                : Named num [1:83] 0.812 0.8 0.812 0.692 0.417 ...
  ..- attr(*, "names")= chr [1:83] "1" "2" "3" "4" ...
 $ converged        : logi TRUE
 $ boundary         : logi FALSE
 $ model            :'data.frame':  83 obs. of  4 variables:
  ..$ cbind(tot - pos, pos): int [1:83, 1:2] 13 12 13 9 5 11 9 7 3 7 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] "" "pos"
  ..$ I(age^1)             : 'AsIs' num [1:83]  1  2  3  4  5  6  7  8  9 10 ...
  ..$ I(age^2)             : 'AsIs' num [1:83]   1   4   9  16  25  36  49  64  81 100 ...
  ..$ I(age^3)             : 'AsIs' num [1:83]    1    8   27   64  125  216  343  512  729 1000 ...
  ..- attr(*, "terms")=Classes 'terms', 'formula'  language cbind(tot - pos, pos) ~ -1 + I(age^1) + I(age^2) + I(age^3)
  .. .. ..- attr(*, "variables")= language list(cbind(tot - pos, pos), I(age^1), I(age^2), I(age^3))
  .. .. ..- attr(*, "factors")= int [1:4, 1:3] 0 1 0 0 0 0 1 0 0 0 ...
  .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. ..$ : chr [1:4] "cbind(tot - pos, pos)" "I(age^1)" "I(age^2)" "I(age^3)"
  .. .. .. .. ..$ : chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  .. .. ..- attr(*, "term.labels")= chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  .. .. ..- attr(*, "order")= int [1:3] 1 1 1
  .. .. ..- attr(*, "intercept")= int 0
  .. .. ..- attr(*, "response")= int 1
  .. .. ..- attr(*, ".Environment")=&lt;environment: 0x55897f6b11e0&gt; 
  .. .. ..- attr(*, "predvars")= language list(cbind(tot - pos, pos), I(age^1), I(age^2), I(age^3))
  .. .. ..- attr(*, "dataClasses")= Named chr [1:4] "nmatrix.2" "numeric" "numeric" "numeric"
  .. .. .. ..- attr(*, "names")= chr [1:4] "cbind(tot - pos, pos)" "I(age^1)" "I(age^2)" "I(age^3)"
 $ call             : language glm(formula = as.formula(f), family = binomial(link = "log"))
 $ formula          :Class 'formula'  language cbind(tot - pos, pos) ~ -1 + I(age^1) + I(age^2) + I(age^3)
  .. ..- attr(*, ".Environment")=&lt;environment: 0x55897f6b11e0&gt; 
 $ terms            :Classes 'terms', 'formula'  language cbind(tot - pos, pos) ~ -1 + I(age^1) + I(age^2) + I(age^3)
  .. ..- attr(*, "variables")= language list(cbind(tot - pos, pos), I(age^1), I(age^2), I(age^3))
  .. ..- attr(*, "factors")= int [1:4, 1:3] 0 1 0 0 0 0 1 0 0 0 ...
  .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. ..$ : chr [1:4] "cbind(tot - pos, pos)" "I(age^1)" "I(age^2)" "I(age^3)"
  .. .. .. ..$ : chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  .. ..- attr(*, "term.labels")= chr [1:3] "I(age^1)" "I(age^2)" "I(age^3)"
  .. ..- attr(*, "order")= int [1:3] 1 1 1
  .. ..- attr(*, "intercept")= int 0
  .. ..- attr(*, "response")= int 1
  .. ..- attr(*, ".Environment")=&lt;environment: 0x55897f6b11e0&gt; 
  .. ..- attr(*, "predvars")= language list(cbind(tot - pos, pos), I(age^1), I(age^2), I(age^3))
  .. ..- attr(*, "dataClasses")= Named chr [1:4] "nmatrix.2" "numeric" "numeric" "numeric"
  .. .. ..- attr(*, "names")= chr [1:4] "cbind(tot - pos, pos)" "I(age^1)" "I(age^2)" "I(age^3)"
 $ data             :&lt;environment: 0x55897f6b11e0&gt; 
 $ offset           : NULL
 $ control          :List of 3
  ..$ epsilon: num 1e-08
  ..$ maxit  : num 25
  ..$ trace  : logi FALSE
 $ method           : chr "glm.fit"
 $ contrasts        : NULL
 $ xlevels          : Named list()
 - attr(*, "class")= chr [1:2] "glm" "lm"</code></pre>
</div>
</div>
<p><strong>fitted value: the fitted mean values, obtained by transforming the linear predictors by the inverse of the link function.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(polymodel<span class="sc">$</span>info<span class="sc">$</span>fitted.values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6 
0.9486049 0.9007083 0.8559922 0.8141713 0.7749889 0.7382143 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(polymodel<span class="sc">$</span>sp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         1          2          3          4          5          6 
0.05139506 0.09929169 0.14400779 0.18582874 0.22501109 0.26178575 </code></pre>
</div>
</div>
<p><strong>ABOUT OPERATOR</strong></p>
<p>The operator “%*%” is used for matrix multiplication satisfying the condition that the number of columns in the first matrix is equal to the number of rows in second.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">nrow=</span><span class="dv">4</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4]
[1,]    1    3    5    7
[2,]    2    4    6    8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    8   12
[2,]    9   13
[3,]   10   14
[4,]   11   15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(m <span class="sc">%*%</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]  162  226
[2,]  200  280</code></pre>
</div>
</div>
<p>This is how multiplication takes place:</p>
<pre><code>1*8+3*9+5*10+7*11 = 162      1*12+3*13+5*14+7*15=226
2*8+4*9+6*10+8*11 = 200      2*12+4*13+6*14+8*15=280</code></pre>
<p><strong>Estimate force of infection</strong></p>
<p><img src="hinh/1.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>polymodel<span class="sc">$</span>info<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     I(age^1)      I(age^2)      I(age^3) 
-5.325918e-02  5.065095e-04 -1.018736e-05 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## X theo Grenfell</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">X</span>(a<span class="sc">$</span>age,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]   -1   -2   -3
[2,]   -1   -4  -12
[3,]   -1   -6  -27
[4,]   -1   -8  -48
[5,]   -1  -10  -75
[6,]   -1  -12 -108</code></pre>
</div>
</div>
<p>Calculation of FOI in Long’s code</p>
<pre><code>model$foi &lt;- X%*%model$info$coefficients</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(polymodel<span class="sc">$</span>foi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,] 0.05227672
[2,] 0.05135539
[3,] 0.05049518
[4,] 0.04969609
[5,] 0.04895813
[6,] 0.04828130</code></pre>
</div>
</div>
<p><strong>function to plot polynomial</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>plot.polynomial_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  CEX_SCALER <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># arbitrary number for better visual</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x<span class="sc">$</span>df, {</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">las=</span><span class="dv">1</span>,<span class="at">cex.axis=</span><span class="dv">1</span>,<span class="at">cex.lab=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">mgp=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.5</span>, <span class="dv">0</span>),<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>      age,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      pos<span class="sc">/</span>tot,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex=</span>CEX_SCALER<span class="sc">*</span>tot<span class="sc">/</span><span class="fu">max</span>(tot),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"age"</span>, <span class="at">ylab=</span><span class="st">"seroprevalence"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(age, x<span class="sc">$</span>sp, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(age, x<span class="sc">$</span>foi, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="at">at=</span><span class="fu">round</span>(<span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fu">max</span>(x<span class="sc">$</span>foi), <span class="at">length.out=</span><span class="dv">3</span>), <span class="dv">2</span>))</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="st">"force of infection"</span>, <span class="at">las=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.polynomial_model</span>(polymodel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="coded_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="hinh/2.png" class="img-fluid"></p>
</div>
</div>
</div>
<p><strong>test polynomial function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats4)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Muench)"</span>, {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0505004</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">deg=</span><span class="dv">1</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎊</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Griffiths)"</span>, {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0442615740</span>, <span class="sc">-</span><span class="fl">0.0001888796</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">deg=</span><span class="dv">2</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🌈</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Grenfell &amp; Anderson)"</span>, {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">5.325918e-02</span>, <span class="fl">5.065095e-04</span>, <span class="sc">-</span><span class="fl">1.018736e-05</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">deg=</span><span class="dv">3</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>],</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">3</span>]</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
</div>
</section>
<section id="nonlinear-models" class="level2">
<h2 class="anchored" data-anchor-id="nonlinear-models">6.1.2 Nonlinear Models</h2>
<p><img src="hinh/3.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>farrington_model <span class="ot">&lt;-</span> <span class="cf">function</span>(age, pos, tot, start, <span class="at">fixed=</span><span class="fu">list</span>())</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  farrington <span class="ot">&lt;-</span> <span class="cf">function</span>(alpha,beta,gamma) {</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    p<span class="ot">=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>((alpha<span class="sc">/</span>beta)<span class="sc">*</span>age<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>age)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>            <span class="sc">+</span>(<span class="dv">1</span><span class="sc">/</span>beta)<span class="sc">*</span>((alpha<span class="sc">/</span>beta)<span class="sc">-</span>gamma)<span class="sc">*</span>(<span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>age)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">-</span>gamma<span class="sc">*</span>age)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    ll<span class="ot">=</span>pos<span class="sc">*</span><span class="fu">log</span>(p)<span class="sc">+</span>(tot<span class="sc">-</span>pos)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="sc">-</span><span class="fu">sum</span>(ll))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">mle</span>(farrington, <span class="at">fixed=</span>fixed, <span class="at">start=</span>start)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">1</span>]</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  beta  <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">2</span>]</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">3</span>]</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    (alpha<span class="sc">/</span>beta)<span class="sc">*</span>age<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>age)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="sc">+</span>(<span class="dv">1</span><span class="sc">/</span>beta)<span class="sc">*</span>((alpha<span class="sc">/</span>beta)<span class="sc">-</span>gamma)<span class="sc">*</span>(<span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>age)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>gamma<span class="sc">*</span>age)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> (alpha<span class="sc">*</span>age<span class="sc">-</span>gamma)<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>beta<span class="sc">*</span>age)<span class="sc">+</span>gamma</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot=</span>tot)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"farrington_model"</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> rubella_uk_1986_1987</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">farrington_model</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>   df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">start=</span><span class="fu">list</span>(<span class="at">alpha=</span><span class="fl">0.07</span>,<span class="at">beta=</span><span class="fl">0.1</span>,<span class="at">gamma=</span><span class="fl">0.03</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>   )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Warning in log(p): NaNs produced

Warning in log(p): NaNs produced

Warning in log(p): NaNs produced

Warning in log(p): NaNs produced</code></pre>
<p><strong>Vì model ra kết quả như trên nên xử lí bằng suppressWarnings </strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">farrington_model</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>   df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">start=</span><span class="fu">list</span>(<span class="at">alpha=</span><span class="fl">0.07</span>,<span class="at">beta=</span><span class="fl">0.1</span>,<span class="at">gamma=</span><span class="fl">0.03</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>   ))</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(model<span class="sc">$</span>info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Formal class 'mle' [package "stats4"] with 10 slots
  ..@ call     : language mle(minuslogl = farrington, start = start, fixed = fixed)
  ..@ coef     : Named num [1:3] 0.0703 0.2024 0.0367
  .. ..- attr(*, "names")= chr [1:3] "alpha" "beta" "gamma"
  ..@ fullcoef : Named num [1:3] 0.0703 0.2024 0.0367
  .. ..- attr(*, "names")= chr [1:3] "alpha" "beta" "gamma"
  ..@ fixed    : Named num [1:3] NA NA NA
  .. ..- attr(*, "names")= chr [1:3] "alpha" "beta" "gamma"
  ..@ vcov     : num [1:3, 1:3] 2.95e-05 8.80e-05 1.83e-05 8.80e-05 6.81e-04 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:3] "alpha" "beta" "gamma"
  .. .. ..$ : chr [1:3] "alpha" "beta" "gamma"
  ..@ min      : num 1947
  ..@ details  :List of 6
  .. ..$ par        : Named num [1:3] 0.0703 0.2024 0.0367
  .. .. ..- attr(*, "names")= chr [1:3] "alpha" "beta" "gamma"
  .. ..$ value      : num 1947
  .. ..$ counts     : Named int [1:2] 110 25
  .. .. ..- attr(*, "names")= chr [1:2] "function" "gradient"
  .. ..$ convergence: int 0
  .. ..$ message    : NULL
  .. ..$ hessian    : num [1:3, 1:3] 261540 -106335 144751 -106335 50086 ...
  .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. ..$ : chr [1:3] "alpha" "beta" "gamma"
  .. .. .. ..$ : chr [1:3] "alpha" "beta" "gamma"
  ..@ minuslogl:function (alpha, beta, gamma)  
  .. ..- attr(*, "srcref")= 'srcref' int [1:8] 3 17 8 3 17 3 3 8
  .. .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' &lt;environment: 0x55897f60f610&gt; 
  ..@ nobs     : int NA
  ..@ method   : chr "BFGS"</code></pre>
</div>
</div>
<p><strong>test function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"farrington_model returns same result as in the book"</span>, {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="fl">0.07034904</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta=</span><span class="fl">0.20243950</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma=</span><span class="fl">0.03665599</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> rubella_uk_1986_1987</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">farrington_model</span>(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>      df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">start=</span><span class="fu">list</span>(<span class="at">alpha=</span><span class="fl">0.07</span>,<span class="at">beta=</span><span class="fl">0.1</span>,<span class="at">gamma=</span><span class="fl">0.03</span>)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">1</span>],</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">2</span>],</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    model<span class="sc">$</span>info<span class="sc">@</span>coef[<span class="dv">3</span>]</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🥇</code></pre>
</div>
</div>
</section>
<section id="weibull-model" class="level2">
<h2 class="anchored" data-anchor-id="weibull-model">Weibull model</h2>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="hinh/4.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="hinh/5.png" class="img-fluid"></p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>weibull_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, spos)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    spos<span class="sc">~</span><span class="fu">log</span>(t),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"cloglog"</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  b0 <span class="ot">&lt;-</span> <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>]</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  b1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> <span class="fu">exp</span>(b0)<span class="sc">*</span>b1<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">log</span>(t))<span class="sc">^</span>(b1<span class="dv">-1</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(b0)<span class="sc">*</span>t<span class="sc">^</span>b1)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">t=</span>t, <span class="at">spos=</span>spos)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"weibull_model"</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>apply</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> hcv_be_2006[<span class="fu">order</span>(hcv_be_2006<span class="sc">$</span>dur),]</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   model <span class="ot">&lt;-</span> <span class="fu">weibull_model</span>(</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">t=</span>df<span class="sc">$</span>dur,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">spos=</span>df<span class="sc">$</span>seropositive</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>info<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)      log(t) 
 -0.2759649   0.3807367 </code></pre>
</div>
</div>
<p><img src="hinh/6.png" class="img-fluid"> <strong>test Weibull model</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"weibull_model returns same result as in the book"</span>, {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  expected_coefs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.27596492</span>, <span class="fl">0.38073667</span>) <span class="co"># page 97</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  expected_beta_0_hat <span class="ot">&lt;-</span> <span class="fl">0.759</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hcv_be_2006[<span class="fu">order</span>(hcv_be_2006<span class="sc">$</span>dur), ]</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">weibull_model</span>(</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">t=</span>df<span class="sc">$</span>dur,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">spos=</span>df<span class="sc">$</span>seropositive</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  actual_coefs <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>], <span class="co"># intercept</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  actual_beta_0_hat <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">unname</span>(<span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>]))</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_coefs, expected_coefs, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_beta_0_hat, expected_beta_0_hat, <span class="at">tolerance=</span><span class="fl">0.001</span>)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🌈</code></pre>
</div>
</div>
</section>
<section id="fractional-polynomial-models" class="level2">
<h2 class="anchored" data-anchor-id="fractional-polynomial-models">6.2 Fractional Polynomial Models</h2>
<p><strong>How to use predict function</strong></p>
<p>create dataframe</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> datasets<span class="sc">::</span>cars</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  speed dist
1     4    2
2     4   10
3     7    4
4     7   22
5     8   16
6     9   10</code></pre>
</div>
</div>
<p>create a linear model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>linear_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(dist<span class="sc">~</span>speed, <span class="at">data =</span> df)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>linear_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = dist ~ speed, data = df)

Coefficients:
(Intercept)        speed  
    -17.579        3.932  </code></pre>
</div>
</div>
<p>apply predict</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>variable_speed <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">speed =</span> <span class="fu">c</span>(<span class="dv">11</span>,<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">12</span>,<span class="dv">12</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">13</span>,<span class="dv">13</span>,<span class="dv">13</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(linear_model, <span class="at">newdata =</span> variable_speed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1        2        3        4        5        6        7        8 
25.67740 25.67740 29.60981 29.60981 29.60981 29.60981 33.54222 33.54222 
       9       10 
33.54222 33.54222 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(linear_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6         7         8 
-1.849460 -1.849460  9.947766  9.947766 13.880175 17.812584 21.744993 21.744993 
        9        10        11        12        13        14        15        16 
21.744993 25.677401 25.677401 29.609810 29.609810 29.609810 29.609810 33.542219 
       17        18        19        20        21        22        23        24 
33.542219 33.542219 33.542219 37.474628 37.474628 37.474628 37.474628 41.407036 
       25        26        27        28        29        30        31        32 
41.407036 41.407036 45.339445 45.339445 49.271854 49.271854 49.271854 53.204263 
       33        34        35        36        37        38        39        40 
53.204263 53.204263 53.204263 57.136672 57.136672 57.136672 61.069080 61.069080 
       41        42        43        44        45        46        47        48 
61.069080 61.069080 61.069080 68.933898 72.866307 76.798715 76.798715 76.798715 
       49        50 
76.798715 80.731124 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(<span class="fu">predict</span>(linear_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        2         3         4         5         6         7         8         9 
 0.000000 11.797226  0.000000  3.932409  3.932409  3.932409  0.000000  0.000000 
       10        11        12        13        14        15        16        17 
 3.932409  0.000000  3.932409  0.000000  0.000000  0.000000  3.932409  0.000000 
       18        19        20        21        22        23        24        25 
 0.000000  0.000000  3.932409  0.000000  0.000000  0.000000  3.932409  0.000000 
       26        27        28        29        30        31        32        33 
 0.000000  3.932409  0.000000  3.932409  0.000000  0.000000  3.932409  0.000000 
       34        35        36        37        38        39        40        41 
 0.000000  0.000000  3.932409  0.000000  0.000000  3.932409  0.000000  0.000000 
       42        43        44        45        46        47        48        49 
 0.000000  0.000000  7.864818  3.932409  3.932409  0.000000  0.000000  0.000000 
       50 
 3.932409 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">predict</span>(linear_model)) <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">==</span> <span class="dv">0</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p><strong>Long function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>is_monotone <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">predict</span>(model))<span class="sc">&lt;</span><span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>formulate <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  equation <span class="ot">&lt;-</span> <span class="st">"cbind(pos,tot-pos)~"</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  prev_term <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(p)) {</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> p[i] <span class="sc">==</span> p[i<span class="dv">-1</span>]) {</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>      cur_term <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I("</span>, prev_term, <span class="st">"*log(age))"</span>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (p[i] <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>      cur_term <span class="ot">&lt;-</span> <span class="st">"log(age)"</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>      cur_term <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I(age^"</span>, p[i], <span class="st">")"</span>)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    equation <span class="ot">&lt;-</span> <span class="fu">paste0</span>(equation, <span class="st">"+"</span>, cur_term)</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    prev_term <span class="ot">&lt;-</span> cur_term</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  equation</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="do">## power in the book</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a><span class="fu">formulate</span>(<span class="fu">c</span>( <span class="sc">-</span><span class="dv">2</span> , <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span> <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cbind(pos,tot-pos)~+I(age^-2)+I(age^-1)+I(age^-0.5)+log(age)+I(age^0.5)+I(age^1)+I(age^2)+I(age^3)"</code></pre>
</div>
</div>
<p><strong>Function to find the best power value</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>find_best_fp_powers <span class="ot">&lt;-</span> <span class="cf">function</span>(age, pos, tot, p, mc, degree, <span class="at">link=</span><span class="st">"logit"</span>){</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  glm_best <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  d_best <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  p_best <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#----</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  min_p <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  max_p <span class="ot">&lt;-</span> <span class="fu">length</span>(p)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">&lt;-</span> <span class="fu">rep</span>(min_p, degree)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> degree</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#----</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  get_cur_p <span class="ot">&lt;-</span> <span class="cf">function</span>(cur_state) {</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    cur_p <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>degree) {</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>      cur_p <span class="ot">&lt;-</span> <span class="fu">c</span>(cur_p, p[cur_state[i]])</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    cur_p</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>      (i <span class="sc">&lt;</span> degree <span class="sc">&amp;&amp;</span> state[i] <span class="sc">==</span> max_p)</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>      <span class="sc">||</span> (i <span class="sc">==</span> degree <span class="sc">&amp;&amp;</span> state[i] <span class="sc">==</span> max_p<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    ) {</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i<span class="dv">-1</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">break</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (state[i<span class="dv">-1</span>] <span class="sc">&lt;</span> max_p) {</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>        state[i<span class="dv">-1</span>] <span class="ot">&lt;-</span> state[i<span class="dv">-1</span>]<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> i<span class="sc">:</span>degree) state[j] <span class="ot">&lt;-</span> state[i<span class="dv">-1</span>]</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">&lt;-</span> degree</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">&lt;-</span> i<span class="dv">-1</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#------ iteration implementation -------</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    p_cur <span class="ot">&lt;-</span> <span class="fu">get_cur_p</span>(state)</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    glm_cur <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.formula</span>(<span class="fu">formulate</span>(p_cur)),</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>link)</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (glm_cur<span class="sc">$</span>converged <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>      d_cur <span class="ot">&lt;-</span> <span class="fu">deviance</span>(glm_cur)</span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(glm_best) <span class="sc">||</span> d_cur <span class="sc">&lt;</span> d_best) {</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((mc <span class="sc">&amp;&amp;</span> <span class="fu">is_monotone</span>(glm_cur)) <span class="sc">|</span> <span class="sc">!</span>mc) {</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>          glm_best <span class="ot">&lt;-</span> glm_cur</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>          d_best <span class="ot">&lt;-</span> d_cur</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>          p_best <span class="ot">&lt;-</span> p_cur</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">#---------------------------------------</span></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(state <span class="sc">!=</span> max_p) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">break</span></span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>    state[i] <span class="ot">&lt;-</span> state[i]<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">p=</span>p_best, <span class="at">deviance=</span>d_best, <span class="at">model=</span>glm_best))</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> hav_be_1993_1994</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>   best_p <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">find_best_fp_powers</span>(</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>   df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">p=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">3</span>,<span class="fl">0.1</span>), <span class="at">mc=</span><span class="cn">FALSE</span>, <span class="at">degree=</span><span class="dv">2</span>, <span class="at">link=</span><span class="st">"cloglog"</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>best_p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$p
[1] 1.5 1.6

$deviance
[1] 81.60333

$model

Call:  glm(formula = as.formula(formulate(p_cur)), family = binomial(link = link))

Coefficients:
(Intercept)   I(age^1.5)   I(age^1.6)  
   -3.61083      0.12443     -0.07656  

Degrees of Freedom: 85 Total (i.e. Null);  83 Residual
Null Deviance:      1320 
Residual Deviance: 81.6     AIC: 361.2</code></pre>
</div>
</div>
<p><strong>explain function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># degree = 2</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>state <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">3</span>,<span class="fl">0.1</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="st">"p[cur_state[i]]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "p[cur_state[i]]"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>state[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>p[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>p[state[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>p_cur <span class="ot">&lt;-</span> <span class="fu">c</span>(p[state[<span class="dv">1</span>]],p[state[<span class="dv">2</span>]])</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>p_cur</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2 -2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">formulate</span>(p_cur)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cbind(pos,tot-pos)~+I(age^-2)+I(I(age^-2)*log(age))"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="fu">formulate</span>(p_cur))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(best_p<span class="sc">$</span>model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 30
 $ coefficients     : Named num [1:3] -3.6108 0.1244 -0.0766
  ..- attr(*, "names")= chr [1:3] "(Intercept)" "I(age^1.5)" "I(age^1.6)"
 $ residuals        : Named num [1:86] -1.014 -1.014 -1.015 1.822 0.892 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ fitted.values    : Named num [1:86] 0.0272 0.028 0.03 0.0326 0.0355 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ effects          : Named num [1:86] -2.62 21.77 15.42 1.62 1.02 ...
  ..- attr(*, "names")= chr [1:86] "(Intercept)" "I(age^1.5)" "I(age^1.6)" "" ...
 $ R                : num [1:3, 1:3] -37.5 0 0 -13396.1 5943.1 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:3] "(Intercept)" "I(age^1.5)" "I(age^1.6)"
  .. ..$ : chr [1:3] "(Intercept)" "I(age^1.5)" "I(age^1.6)"
 $ rank             : int 3
 $ qr               :List of 5
  ..$ qr   : num [1:86, 1:3] -37.473 0.0148 0.0113 0.0226 0.0276 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:86] "1" "2" "3" "4" ...
  .. .. ..$ : chr [1:3] "(Intercept)" "I(age^1.5)" "I(age^1.6)"
  ..$ rank : int 3
  ..$ qraux: num [1:3] 1.01 1.03 1.06
  ..$ pivot: int [1:3] 1 2 3
  ..$ tol  : num 1e-11
  ..- attr(*, "class")= chr "qr"
 $ family           :List of 13
  ..$ family    : chr "binomial"
  ..$ link      : chr "cloglog"
  ..$ linkfun   :function (mu)  
  ..$ linkinv   :function (eta)  
  ..$ variance  :function (mu)  
  ..$ dev.resids:function (y, mu, wt)  
  ..$ aic       :function (y, n, mu, wt, dev)  
  ..$ mu.eta    :function (eta)  
  ..$ initialize: language {     if (NCOL(y) == 1) { ...
  ..$ validmu   :function (mu)  
  ..$ valideta  :function (eta)  
  ..$ simulate  :function (object, nsim)  
  ..$ dispersion: num 1
  ..- attr(*, "class")= chr "family"
 $ linear.predictors: Named num [1:86] -3.59 -3.56 -3.49 -3.41 -3.32 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ deviance         : num 81.6
 $ aic              : num 361
 $ null.deviance    : num 1320
 $ iter             : int 4
 $ weights          : Named num [1:86] 0.109 0.308 0.18 0.716 1.066 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ prior.weights    : Named num [1:86] 4 11 6 22 30 56 73 43 39 34 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ df.residual      : int 83
 $ df.null          : int 85
 $ y                : Named num [1:86] 0 0 0 0.0909 0.0667 ...
  ..- attr(*, "names")= chr [1:86] "1" "2" "3" "4" ...
 $ converged        : logi TRUE
 $ boundary         : logi FALSE
 $ model            :'data.frame':  86 obs. of  3 variables:
  ..$ cbind(pos, tot - pos): int [1:86, 1:2] 0 0 0 2 2 1 3 5 2 3 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : NULL
  .. .. ..$ : chr [1:2] "pos" ""
  ..$ I(age^1.5)           : 'AsIs' num [1:86] 0.353553....            1 2.828427.... 5.196152....            8 ...
  ..$ I(age^1.6)           : 'AsIs' num [1:86] 0.329876....            1 3.031433.... 5.799546.... 9.189586.... ...
  ..- attr(*, "terms")=Classes 'terms', 'formula'  language cbind(pos, tot - pos) ~ +I(age^1.5) + I(age^1.6)
  .. .. ..- attr(*, "variables")= language list(cbind(pos, tot - pos), I(age^1.5), I(age^1.6))
  .. .. ..- attr(*, "factors")= int [1:3, 1:2] 0 1 0 0 0 1
  .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. ..$ : chr [1:3] "cbind(pos, tot - pos)" "I(age^1.5)" "I(age^1.6)"
  .. .. .. .. ..$ : chr [1:2] "I(age^1.5)" "I(age^1.6)"
  .. .. ..- attr(*, "term.labels")= chr [1:2] "I(age^1.5)" "I(age^1.6)"
  .. .. ..- attr(*, "order")= int [1:2] 1 1
  .. .. ..- attr(*, "intercept")= int 1
  .. .. ..- attr(*, "response")= int 1
  .. .. ..- attr(*, ".Environment")=&lt;environment: 0x5589820c1838&gt; 
  .. .. ..- attr(*, "predvars")= language list(cbind(pos, tot - pos), I(age^1.5), I(age^1.6))
  .. .. ..- attr(*, "dataClasses")= Named chr [1:3] "nmatrix.2" "numeric" "numeric"
  .. .. .. ..- attr(*, "names")= chr [1:3] "cbind(pos, tot - pos)" "I(age^1.5)" "I(age^1.6)"
 $ call             : language glm(formula = as.formula(formulate(p_cur)), family = binomial(link = link))
 $ formula          :Class 'formula'  language cbind(pos, tot - pos) ~ +I(age^1.5) + I(age^1.6)
  .. ..- attr(*, ".Environment")=&lt;environment: 0x5589820c1838&gt; 
 $ terms            :Classes 'terms', 'formula'  language cbind(pos, tot - pos) ~ +I(age^1.5) + I(age^1.6)
  .. ..- attr(*, "variables")= language list(cbind(pos, tot - pos), I(age^1.5), I(age^1.6))
  .. ..- attr(*, "factors")= int [1:3, 1:2] 0 1 0 0 0 1
  .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. ..$ : chr [1:3] "cbind(pos, tot - pos)" "I(age^1.5)" "I(age^1.6)"
  .. .. .. ..$ : chr [1:2] "I(age^1.5)" "I(age^1.6)"
  .. ..- attr(*, "term.labels")= chr [1:2] "I(age^1.5)" "I(age^1.6)"
  .. ..- attr(*, "order")= int [1:2] 1 1
  .. ..- attr(*, "intercept")= int 1
  .. ..- attr(*, "response")= int 1
  .. ..- attr(*, ".Environment")=&lt;environment: 0x5589820c1838&gt; 
  .. ..- attr(*, "predvars")= language list(cbind(pos, tot - pos), I(age^1.5), I(age^1.6))
  .. ..- attr(*, "dataClasses")= Named chr [1:3] "nmatrix.2" "numeric" "numeric"
  .. .. ..- attr(*, "names")= chr [1:3] "cbind(pos, tot - pos)" "I(age^1.5)" "I(age^1.6)"
 $ data             :&lt;environment: 0x5589820c1838&gt; 
 $ offset           : NULL
 $ control          :List of 3
  ..$ epsilon: num 1e-08
  ..$ maxit  : num 25
  ..$ trace  : logi FALSE
 $ method           : chr "glm.fit"
 $ contrasts        : NULL
 $ xlevels          : Named list()
 - attr(*, "class")= chr [1:2] "glm" "lm"</code></pre>
</div>
</div>
<p><strong>test function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"find_best_fp_powers returns same result as in the book (non-monotone)"</span>, {</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  expected_p <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.9</span>, <span class="fl">2.0</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_be_1993_1994</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">find_best_fp_powers</span>(</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">p=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">3</span>,<span class="fl">0.1</span>), <span class="at">mc=</span>F, <span class="at">degree=</span><span class="dv">2</span>, <span class="at">link=</span><span class="st">"logit"</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>  actual_p <span class="ot">&lt;-</span> output<span class="sc">$</span>p</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_p, expected_p)</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🥳</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"find_best_fp_powers returns same result as in the book (monotone)"</span>, {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  expected_p <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.0</span>, <span class="fl">1.6</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_be_1993_1994</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">find_best_fp_powers</span>(</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">p=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">3</span>,<span class="fl">0.1</span>), <span class="at">mc=</span>T, <span class="at">degree=</span><span class="dv">2</span>, <span class="at">link=</span><span class="st">"logit"</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  actual_p <span class="ot">&lt;-</span> output<span class="sc">$</span>p</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_p, expected_p)</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
</div>
<p><strong>fractional polynomial function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ultis</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>est_foi <span class="ot">&lt;-</span> <span class="cf">function</span>(t, sp)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  dsp <span class="ot">&lt;-</span> <span class="fu">diff</span>(sp)<span class="sc">/</span><span class="fu">diff</span>(t)</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  foi <span class="ot">&lt;-</span> <span class="fu">approx</span>(</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    (t[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>t[<span class="sc">-</span><span class="fu">length</span>(t)])<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    dsp,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    t[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(t))]</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>sp[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(t))])</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  foi</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>fp_model <span class="ot">&lt;-</span> <span class="cf">function</span>(age, pos, tot, p, <span class="at">link=</span><span class="st">"logit"</span>) {</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.formula</span>(<span class="fu">formulate</span>(p)),</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>link)</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp  <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> <span class="fu">est_foi</span>(</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">t=</span>age,</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp=</span>model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot=</span>tot)</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"fp_model"</span></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>apply</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> hav_be_1993_1994</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>   model <span class="ot">&lt;-</span> <span class="fu">fp_model</span>(</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>   df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">p=</span><span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">1.6</span>), <span class="at">link=</span><span class="st">"cloglog"</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="coded_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>test function</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"fp_model returns same result as in the book (Hepatitis A (BG))"</span>, {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  expected_coefs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.09473686</span>, <span class="fl">0.02622843</span>, <span class="sc">-</span><span class="fl">0.01613128</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  expected_D <span class="ot">&lt;-</span> <span class="fl">77.748963</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">fp_model</span>(</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot,</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">p=</span><span class="fu">c</span>(<span class="fl">1.9</span>, <span class="fl">2.0</span>), <span class="at">link=</span><span class="st">"logit"</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  actual_coefs <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>], <span class="co"># intercept</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>],</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">3</span>]</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  actual_D <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">$</span>deviance</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_coefs, expected_coefs)</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_D, expected_D)</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎊</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>