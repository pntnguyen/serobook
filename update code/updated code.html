<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Updated code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="updated code_files/libs/clipboard/clipboard.min.js"></script>
<script src="updated code_files/libs/quarto-html/quarto.js"></script>
<script src="updated code_files/libs/quarto-html/popper.min.js"></script>
<script src="updated code_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="updated code_files/libs/quarto-html/anchor.min.js"></script>
<link href="updated code_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="updated code_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="updated code_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="updated code_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="updated code_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Updated code</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="install-package-serosv" class="level2">
<h2 class="anchored" data-anchor-id="install-package-serosv">Install package “serosv”</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"OUCRU-Modelling/serosv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(serosv)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chap-6" class="level2">
<h2 class="anchored" data-anchor-id="chap-6"><strong>Chap 6</strong></h2>
</section>
<section id="polynomial-model" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-model">Polynomial model</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="cf">function</span>(t, degree) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  X_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(t)), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (degree <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>degree) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      X_matrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X_matrix, i <span class="sc">*</span> t<span class="sc">^</span>(i<span class="dv">-1</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>X_matrix</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' Polynomial models</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'Refers to section 6.1.1</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param age the age vector</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param positive the positive vector</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param negative the negative vector</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k  degree of the model</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type name of method</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' a &lt;- hav_bg_1964</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' a$neg &lt;- a$tot - a$pos</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' model &lt;- polynomial_model(a$age, a$pos, a$neg, type = "Muench")</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>polynomial_model <span class="ot">&lt;-</span> <span class="cf">function</span>(age,positive,negative,k,type){</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  Age <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(age)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  Pos <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(positive)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  Neg <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(negative)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(Age, Pos,Neg))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(k)){</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> <span class="cf">switch</span>(type,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Muench"</span> <span class="ot">=</span> <span class="dv">1</span> ,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Griffith"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Grenfell"</span> <span class="ot">=</span> <span class="dv">3</span>)}</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  age <span class="ot">&lt;-</span> <span class="cf">function</span>(k){</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(k<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      formula<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I"</span>,<span class="st">"("</span>,<span class="fu">paste</span>(<span class="st">"Age"</span>, <span class="dv">2</span><span class="sc">:</span>k,<span class="at">sep =</span> <span class="st">"^"</span>),<span class="st">")"</span>,<span class="at">collapse =</span> <span class="st">"+"</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cbind(Neg,Pos)"</span>,<span class="st">" ~"</span>,<span class="st">"-1+Age+"</span>,formula)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cbind(Neg,Pos)"</span>,<span class="st">" ~"</span>,<span class="st">"-1+Age"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">age</span>(k), <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"log"</span>),df)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">X</span>(Age, k)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> X<span class="sc">%*%</span>model<span class="sc">$</span>info<span class="sc">$</span>coefficients</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Age=</span>Age, <span class="at">Pos=</span>Pos, <span class="at">Tot=</span> Pos <span class="sc">+</span> Neg)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"polynomial_model"</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="cf">function</span>(t, degree) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  X_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(t)), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (degree <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>degree) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      X_matrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X_matrix, i <span class="sc">*</span> t<span class="sc">^</span>(i<span class="dv">-1</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>X_matrix</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="do">## polynomial_model with link</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>polynomial_model1 <span class="ot">&lt;-</span> <span class="cf">function</span>(age,positive,negative,<span class="at">link =</span> <span class="st">"log"</span>,k,type){</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  Age <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(age)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  Pos <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(positive)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  Neg <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(negative)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(Age, Pos,Neg))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">missing</span>(k)){</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> <span class="cf">switch</span>(type,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Muench"</span> <span class="ot">=</span> <span class="dv">1</span> ,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Griffith"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Grenfell"</span> <span class="ot">=</span> <span class="dv">3</span>)}</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  age <span class="ot">&lt;-</span> <span class="cf">function</span>(k){</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(k<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      formula<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"I"</span>,<span class="st">"("</span>,<span class="fu">paste</span>(<span class="st">"Age"</span>, <span class="dv">2</span><span class="sc">:</span>k,<span class="at">sep =</span> <span class="st">"^"</span>),<span class="st">")"</span>,<span class="at">collapse =</span> <span class="st">"+"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cbind(Neg,Pos)"</span>,<span class="st">" ~"</span>,<span class="st">"-1+Age+"</span>,formula)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cbind(Neg,Pos)"</span>,<span class="st">" ~"</span>,<span class="st">"-1+Age"</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">age</span>(k), <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span> link),df)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">X</span>(Age, k)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> X<span class="sc">%*%</span>model<span class="sc">$</span>info<span class="sc">$</span>coefficients</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Age=</span>Age, <span class="at">Pos=</span>Pos, <span class="at">Neg =</span> Neg, <span class="at">Tot=</span> Pos <span class="sc">+</span> Neg)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"polynomial_model"</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Unit test</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats4)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Muench)"</span>, {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0505004</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot <span class="sc">-</span> df<span class="sc">$</span>pos,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">type=</span> <span class="st">"Muench"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Muench)"</span>, {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0505004</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot <span class="sc">-</span> df<span class="sc">$</span>pos,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">1</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Griffiths)"</span>, {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0442615740</span>, <span class="sc">-</span><span class="fl">0.0001888796</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot <span class="sc">-</span> df<span class="sc">$</span>pos,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"Griffith"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Griffiths)"</span>, {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.0442615740</span>, <span class="sc">-</span><span class="fl">0.0001888796</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot <span class="sc">-</span> df<span class="sc">$</span>pos,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">2</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 😀</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Grenfell &amp; Anderson)"</span>, {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">5.325918e-02</span>, <span class="fl">5.065095e-04</span>, <span class="sc">-</span><span class="fl">1.018736e-05</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot<span class="sc">-</span>df<span class="sc">$</span>pos,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"Grenfell"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>],</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">3</span>]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 😀</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"polynomial_model returns same result as in the book (Grenfell &amp; Anderson)"</span>, {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">5.325918e-02</span>, <span class="fl">5.065095e-04</span>, <span class="sc">-</span><span class="fl">1.018736e-05</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>pos, df<span class="sc">$</span>tot<span class="sc">-</span>df<span class="sc">$</span>pos,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">3</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>],</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>],</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">3</span>]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual, expected, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🥳</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="new-version-of-plot.polynomial-function" class="level2">
<h2 class="anchored" data-anchor-id="new-version-of-plot.polynomial-function"><strong>New version of plot.polynomial function</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Polynomial model</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>plot_polynomial_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">ci =</span> .<span class="dv">95</span>,<span class="at">le =</span> <span class="dv">100</span>, ...) {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate 95% CI</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  link_inv <span class="ot">&lt;-</span> x<span class="sc">$</span>info<span class="sc">$</span>family<span class="sc">$</span>linkinv</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> x<span class="sc">$</span>info<span class="sc">$</span>data</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dataset) <span class="sc">-</span> <span class="fu">length</span>(x<span class="sc">$</span>info<span class="sc">$</span>coefficients)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  age_range <span class="ot">&lt;-</span> <span class="fu">range</span>(dataset<span class="sc">$</span>Age)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  ages <span class="ot">&lt;-</span> <span class="fu">seq</span>(age_range[<span class="dv">1</span>], age_range[<span class="dv">2</span>], <span class="at">le =</span> le)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  mod1 <span class="ot">&lt;-</span> <span class="fu">predict.glm</span>(model1<span class="sc">$</span>info,<span class="fu">data.frame</span>(<span class="at">Age =</span> ages), <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> mod1 <span class="sc">|&gt;</span> <span class="fu">extract</span>(<span class="fu">c</span>(<span class="st">"fit"</span>, <span class="st">"se.fit"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">age =</span> <span class="fu">list</span>(ages), .) <span class="sc">%&gt;%</span> </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lwr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(    p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">upr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(<span class="dv">1</span> <span class="sc">-</span> p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">fit =</span> <span class="fu">link_inv</span>(fit)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>se.fit)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> n1<span class="sc">$</span>age, <span class="at">y =</span> <span class="dv">1</span><span class="sc">-</span> n1<span class="sc">$</span>fit, <span class="at">ymin=</span> <span class="dv">1</span><span class="sc">-</span>  n1<span class="sc">$</span>lwr, <span class="at">ymax=</span><span class="dv">1</span><span class="sc">-</span> n1<span class="sc">$</span>upr)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x<span class="sc">$</span>df, {</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>df), <span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>Age, <span class="at">y =</span> x<span class="sc">$</span>df<span class="sc">$</span>Pos<span class="sc">/</span>x<span class="sc">$</span>df<span class="sc">$</span>Tot)) <span class="sc">+</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">20</span><span class="sc">*</span>(x<span class="sc">$</span>df<span class="sc">$</span>Pos)<span class="sc">/</span><span class="fu">max</span>(x<span class="sc">$</span>df<span class="sc">$</span>Tot), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Age"</span>)<span class="sc">+</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,<span class="at">lwd=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="fu">aes</span>( <span class="at">x =</span> Age, <span class="at">y =</span> <span class="fu">as.numeric</span>(model1<span class="sc">$</span>foi)),</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"#fc0328"</span>,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_y_continuous</span>(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-polynomial-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-polynomial-model"><strong>Plot polynomial model</strong></h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>muench_model<span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(age,pos,neg,<span class="at">k =</span><span class="dv">1</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muench_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>model1<span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(age,pos,neg,<span class="at">k =</span><span class="dv">1</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_polynomial_model</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>muench_model<span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(age,pos,neg,<span class="at">k =</span><span class="dv">2</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muench_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>model1<span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(age,pos,neg,<span class="at">k =</span><span class="dv">2</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_polynomial_model</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>muench_model<span class="ot">&lt;-</span> <span class="fu">polynomial_model</span>(age,pos,neg,<span class="at">k =</span><span class="dv">3</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(muench_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>neg <span class="ot">&lt;-</span> a<span class="sc">$</span>tot <span class="sc">-</span>a<span class="sc">$</span>pos</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>pos <span class="ot">&lt;-</span> a<span class="sc">$</span>pos</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> a<span class="sc">$</span>age</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>tot <span class="ot">&lt;-</span> a<span class="sc">$</span>tot</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>model1<span class="ot">&lt;-</span> <span class="fu">polynomial_model1</span>(age,pos,neg,<span class="at">k =</span><span class="dv">3</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_polynomial_model</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
<p style="text-align: center;">
<strong>Note: Do FOI em chưa biết cách tính 95% CI nên chưa plot được</strong>
</p>
</section>
<section id="plot-farrington-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-farrington-model"><strong>Plot Farrington model</strong></h2>
<p><strong>Do function predict chỉ dùng cho các kết quả fit ra từ các function như glm,lm,gam. Farrington model dùng mle nên không bỏ vào được function predict để tính được SE</strong></p>
</section>
<section id="new-version-of-plot.weibull_model-function" class="level2">
<h2 class="anchored" data-anchor-id="new-version-of-plot.weibull_model-function"><strong>New version of plot.weibull_model function</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plot_weibull_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x,<span class="at">ci =</span> .<span class="dv">95</span>, ...){</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  df_ <span class="ot">&lt;-</span> serosv<span class="sc">::</span><span class="fu">transform</span>(x<span class="sc">$</span>df<span class="sc">$</span>t, x<span class="sc">$</span>df<span class="sc">$</span>spos)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(df_)[<span class="fu">names</span>(df_) <span class="sc">==</span> <span class="st">"t"</span>] <span class="ot">&lt;-</span> <span class="st">"exposure"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate 95% CI</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  link_inv <span class="ot">&lt;-</span> x<span class="sc">$</span>info<span class="sc">$</span>family<span class="sc">$</span>linkinv</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> x<span class="sc">$</span>info<span class="sc">$</span>model</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dataset) <span class="sc">-</span> <span class="fu">length</span>(x<span class="sc">$</span>info<span class="sc">$</span>coefficients)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  age_range <span class="ot">&lt;-</span> <span class="fu">range</span>(dataset<span class="sc">$</span><span class="st">`</span><span class="at">log(t)</span><span class="st">`</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  exposure_time <span class="ot">&lt;-</span> dataset<span class="sc">$</span><span class="st">`</span><span class="at">log(t)</span><span class="st">`</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  mod1 <span class="ot">&lt;-</span> <span class="fu">predict.glm</span>(x<span class="sc">$</span>info,<span class="fu">data.frame</span>(<span class="st">"log(t)"</span> <span class="ot">=</span> exposure_time), <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> mod1 <span class="sc">|&gt;</span> <span class="fu">extract</span>(<span class="fu">c</span>(<span class="st">"fit"</span>, <span class="st">"se.fit"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">exposure =</span> <span class="fu">list</span>(exposure_time), .) <span class="sc">%&gt;%</span> </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lwr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(    p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">upr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(<span class="dv">1</span> <span class="sc">-</span> p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">fit =</span> <span class="fu">link_inv</span>(fit)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>se.fit)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>t, <span class="at">y =</span> n1<span class="sc">$</span>fit, </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymin=</span> n1<span class="sc">$</span>lwr, <span class="at">ymax=</span> n1<span class="sc">$</span>upr)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(df_), <span class="fu">aes</span>(<span class="at">x =</span> df_<span class="sc">$</span>exposure, <span class="at">y =</span> df_<span class="sc">$</span>pos<span class="sc">/</span>df_<span class="sc">$</span>tot))<span class="sc">+</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span><span class="sc">*</span>(df_<span class="sc">$</span>pos)<span class="sc">/</span><span class="fu">max</span>(df_<span class="sc">$</span>tot), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Exposure"</span>)<span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(df_<span class="sc">$</span>exposure)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> x<span class="sc">$</span>df,</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>t, <span class="at">y =</span> x<span class="sc">$</span>foi),</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">"#fc0328"</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>              <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_y_continuous</span>(</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-weibull-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-weibull-model"><strong>Plot Weibull model</strong></h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>hcv <span class="ot">&lt;-</span> hcv_be_2006[<span class="fu">order</span>(hcv_be_2006<span class="sc">$</span>dur), ]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>dur <span class="ot">&lt;-</span> hcv<span class="sc">$</span>dur</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>infected <span class="ot">&lt;-</span> hcv<span class="sc">$</span>seropositive</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>wb_md <span class="ot">&lt;-</span> <span class="fu">weibull_model</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">t=</span> dur ,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">spos=</span> infected</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wb_md)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>hcv <span class="ot">&lt;-</span> hcv_be_2006[<span class="fu">order</span>(hcv_be_2006<span class="sc">$</span>dur), ]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>dur <span class="ot">&lt;-</span> hcv<span class="sc">$</span>dur</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>infected <span class="ot">&lt;-</span> hcv<span class="sc">$</span>seropositive</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>wb_md <span class="ot">&lt;-</span> <span class="fu">weibull_model</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">t=</span> dur ,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">spos=</span> infected</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_weibull_model</span>(wb_md)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section>
<section id="plot-fractional-polynomial" class="level2">
<h2 class="anchored" data-anchor-id="plot-fractional-polynomial"><strong>Plot fractional polynomial</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plot_fp_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x,<span class="at">ci =</span> .<span class="dv">95</span>,<span class="at">le=</span><span class="dv">100</span>,...){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate 95% CI</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  link_inv <span class="ot">&lt;-</span> x<span class="sc">$</span>info<span class="sc">$</span>family<span class="sc">$</span>linkinv</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>df)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dataset) <span class="sc">-</span> <span class="fu">length</span>(x<span class="sc">$</span>info<span class="sc">$</span>coefficients)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  age_range <span class="ot">&lt;-</span> <span class="fu">range</span>(dataset<span class="sc">$</span>age)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  ages <span class="ot">&lt;-</span> <span class="fu">seq</span>(age_range[<span class="dv">1</span>], age_range[<span class="dv">2</span>], <span class="at">le =</span> le)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  mod1 <span class="ot">&lt;-</span> <span class="fu">predict.glm</span>(x<span class="sc">$</span>info,<span class="fu">data.frame</span>(<span class="at">age =</span> ages), <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  n1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(mod1)[,<span class="sc">-</span><span class="dv">3</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">age =</span> <span class="fu">list</span>(ages), .) <span class="sc">%&gt;%</span> </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lwr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(    p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">upr =</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(<span class="dv">1</span> <span class="sc">-</span> p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">fit =</span> <span class="fu">link_inv</span>(fit)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>se.fit)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> n1<span class="sc">$</span>age, <span class="at">y =</span> n1<span class="sc">$</span>fit, </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymin=</span> n1<span class="sc">$</span>lwr, <span class="at">ymax=</span> n1<span class="sc">$</span>upr)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>df), <span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>age, <span class="at">y =</span> x<span class="sc">$</span>df<span class="sc">$</span>pos<span class="sc">/</span>x<span class="sc">$</span>df<span class="sc">$</span>tot))<span class="sc">+</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span><span class="sc">*</span>(x<span class="sc">$</span>df<span class="sc">$</span>tot)<span class="sc">/</span><span class="fu">max</span>(x<span class="sc">$</span>df<span class="sc">$</span>pos), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Age"</span>)<span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>df<span class="sc">$</span>age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(x<span class="sc">$</span>foi), <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> .<span class="dv">5</span>) <span class="sc">+</span>    </span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>df<span class="sc">$</span>age[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(x<span class="sc">$</span>df<span class="sc">$</span>age))], x<span class="sc">$</span>foi),</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>age[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(x<span class="sc">$</span>df<span class="sc">$</span>age))], <span class="at">y =</span> x<span class="sc">$</span>foi),</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">"#fc0328"</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>              <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_fp_model</span>(model,<span class="at">le=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section>
<section id="chap-7" class="level2">
<h2 class="anchored" data-anchor-id="chap-7"><strong>Chap 7</strong></h2>
</section>
<section id="plot-local-polynomial-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-local-polynomial-model"><strong>Plot local polynomial model</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>plot_lp_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x,<span class="at">ci =</span> .<span class="dv">95</span>,...){</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate 95% CI</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  ages <span class="ot">&lt;-</span> x<span class="sc">$</span>df<span class="sc">$</span>age</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  crit<span class="ot">&lt;-</span> <span class="fu">crit</span>(x<span class="sc">$</span>pi,<span class="at">cov =</span> ci)<span class="sc">$</span>crit.val</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  mod1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(x<span class="sc">$</span>pi, <span class="fu">data.frame</span>(<span class="at">a =</span> ages),<span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> ages, <span class="at">y =</span> mod1<span class="sc">$</span>fit,<span class="at">ymin=</span> mod1<span class="sc">$</span>fit<span class="sc">-</span>crit<span class="sc">*</span>(mod1<span class="sc">$</span>se.fit<span class="sc">/</span><span class="dv">100</span>), </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymax=</span> mod1<span class="sc">$</span>fit<span class="sc">+</span>crit<span class="sc">*</span>(mod1<span class="sc">$</span>se.fit<span class="sc">/</span><span class="dv">100</span>))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(x<span class="sc">$</span>df), <span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>age, <span class="at">y =</span> x<span class="sc">$</span>df<span class="sc">$</span>pos<span class="sc">/</span>x<span class="sc">$</span>df<span class="sc">$</span>tot))<span class="sc">+</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span><span class="sc">*</span>(x<span class="sc">$</span>df<span class="sc">$</span>tot)<span class="sc">/</span><span class="fu">max</span>(x<span class="sc">$</span>df<span class="sc">$</span>pos), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Age"</span>)<span class="sc">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(x<span class="sc">$</span>df<span class="sc">$</span>age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="fu">min</span>(x<span class="sc">$</span>foi), <span class="fu">max</span>(out.DF<span class="sc">$</span>ymax)))<span class="sc">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> .<span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x<span class="sc">$</span>df<span class="sc">$</span>age, <span class="at">y =</span> x<span class="sc">$</span>foi),</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">"#fc0328"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>)<span class="sc">+</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>,<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.2</span>)),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.2</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Old</strong></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>New</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(locfit)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_lp_model</span>(lp1,<span class="at">ci=</span>.<span class="dv">95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section>
<section id="chap-8-semiparametric-approaches-to-model-the-prevalence-and-force-of-infection" class="level2">
<h2 class="anchored" data-anchor-id="chap-8-semiparametric-approaches-to-model-the-prevalence-and-force-of-infection"><strong>Chap 8: Semiparametric Approaches to Model the Prevalence and Force of Infection</strong></h2>
<p>Data của package là data đã được tổng hợp lại còn data trong sách là data theo từng ca</p>
</section>
<section id="smoothing-spline" class="level1">
<h1>8.2.1.1 Smoothing Spline</h1>
<p>Package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## data</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>parvovirus<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"D:/OUCRU/serobook/code in the book/Chapter4/VZV-B19-BE.dat"</span>,<span class="at">header=</span>T)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>subset<span class="ot">&lt;-</span>(parvovirus<span class="sc">$</span>age<span class="sc">&gt;</span><span class="fl">0.5</span>)<span class="sc">&amp;</span>(parvovirus<span class="sc">$</span>age<span class="sc">&lt;</span><span class="dv">76</span>)<span class="sc">&amp;</span>(<span class="sc">!</span><span class="fu">is.na</span>(parvovirus<span class="sc">$</span>age))<span class="sc">&amp;!</span><span class="fu">is.na</span>(parvovirus<span class="sc">$</span>parvores)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>parvovirus<span class="ot">&lt;-</span>parvovirus[subset,]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gam)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>find_best_ss_smoothparms <span class="ot">&lt;-</span> <span class="cf">function</span>(age,seropositive,<span class="at">link =</span> <span class="st">"logit"</span>, <span class="at">upper =</span> <span class="dv">100</span>){</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>seropositive[<span class="fu">order</span>(age)]</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>age[<span class="fu">order</span>(age)]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  BICf<span class="ot">&lt;-</span><span class="cf">function</span>(fit){<span class="fu">return</span>(fit<span class="sc">$</span>deviance<span class="sc">+</span><span class="fu">log</span>(<span class="fu">length</span>(fit<span class="sc">$</span>y))<span class="sc">*</span>(fit<span class="sc">$</span>nl.df<span class="sc">+</span><span class="dv">2</span>))}</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  UBRE<span class="ot">&lt;-</span><span class="cf">function</span>(fit){<span class="fu">return</span>(fit<span class="sc">$</span>deviance<span class="sc">+</span><span class="fu">log</span>(<span class="fu">length</span>(fit<span class="sc">$</span>y))<span class="sc">*</span><span class="fu">sum</span>(fit<span class="sc">$</span>edf))}</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  out<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span><span class="dv">4</span>,<span class="at">nrow =</span> upper)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>upper){</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    dfi <span class="ot">&lt;-</span> <span class="dv">1</span><span class="fl">+0.5</span><span class="sc">*</span>i</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    fit.gam <span class="ot">&lt;-</span> gam<span class="sc">::</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">df=</span>dfi),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> link))</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    out[i,] <span class="ot">&lt;-</span> <span class="fu">c</span>(dfi,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">BICf</span>(fit.gam),</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">AIC</span>(fit.gam),</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">UBRE</span>(fit.gam))</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  df.BIC <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">2</span>]),<span class="dv">1</span>]</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  df.AIC <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">3</span>]),<span class="dv">1</span>]</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  df.UBRE <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">4</span>]),<span class="dv">1</span>]</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  val.BIC <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">2</span>]),<span class="dv">2</span>]</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  val.AIC <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">3</span>]),<span class="dv">3</span>]</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  val.UBRE <span class="ot">&lt;-</span> out[<span class="fu">which.min</span>(out[,<span class="dv">4</span>]),<span class="dv">4</span>]</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  opt_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Methods"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"BIC"</span>,<span class="st">"AIC"</span>,<span class="st">"UBRE"</span>),</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>   <span class="ot">=</span> <span class="fu">c</span>(val.BIC,val.AIC,val.UBRE),</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Effective df"</span> <span class="ot">=</span> <span class="fu">c</span>(df.BIC,df.AIC,df.UBRE)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  opt_df</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="fu">find_best_ss_smoothparms</span>(parvovirus<span class="sc">$</span>age,parvovirus<span class="sc">$</span>parvores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Methods    Value Effective.df
1     BIC 3480.799          5.0
2     AIC 3431.338         10.5
3    UBRE 3364.776         51.0</code></pre>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p>Package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>smoothing_splines <span class="ot">&lt;-</span> <span class="cf">function</span>(age,parvores,df,<span class="at">link =</span> <span class="st">"logit"</span>){</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate FOI</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  foi.num <span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>parvores[<span class="fu">order</span>(age)]</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>age[<span class="fu">order</span>(age)]</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">round</span>(a)))</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  neg<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">1</span>,]</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  pos<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">2</span>,]</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  tot<span class="ot">&lt;-</span>neg<span class="sc">+</span>pos</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>info <span class="ot">&lt;-</span> gam<span class="sc">::</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">df=</span>df),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> link))</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">$</span>fitted.values</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  h1 <span class="ot">&lt;-</span> <span class="fu">foi.num</span>(a,model<span class="sc">$</span>sp)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"age"</span> <span class="ot">=</span> h1<span class="sc">$</span>grid, <span class="st">"foi"</span> <span class="ot">=</span> h1<span class="sc">$</span>foi)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot=</span>tot, <span class="at">grid =</span> grid)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"smoothing_splines"</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> <span class="fu">smoothing_splines</span>(parvovirus<span class="sc">$</span>age,parvovirus<span class="sc">$</span>parvores,<span class="at">df=</span><span class="dv">5</span>,<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>summariseee <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(x<span class="sc">$</span>info,<span class="fu">head</span>(x<span class="sc">$</span>sp),<span class="fu">head</span>(x<span class="sc">$</span>foi),</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">head</span>(x<span class="sc">$</span>df<span class="sc">$</span>age),<span class="fu">head</span>(x<span class="sc">$</span>df[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])))</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="fu">summariseee</span>(outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
Call:
gam::gam(formula = y ~ s(a, df = df), family = binomial(link = link))

Degrees of Freedom: 3070 total; 3065 Residual
Residual Deviance: 3432.623 

[[2]]
        1         2         3         4         5         6 
0.1096696 0.1137961 0.1206846 0.1213022 0.1213022 0.1223733 

[[3]]
        age        foi
2 0.8109589 0.03198997
3 1.0478271 0.03391148
4 1.0684932 0.03408850
6 1.1041096 0.03439822
7 1.1068493 0.03442127
8 1.1123288 0.03446771

[[4]]
[1] 18 18 18 18 18 18

[[5]]
[[5]]$pos
  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 
  3   5   6  17  20  23  40  39  45  52  53  53  54  58  55  56  67 107 138  76 
 21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 
 27  76  20  20  26  20  57  16  14  15  16  70  21  16  24  19  74  17  23  10 
 41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 
  9  12   9  63  11   6  10  17  11  19  14  12  10  67  11   7  11  11   5  17 
 61  62  63  64  65  66  72 
 20  15  25  72  16   2   1 

[[5]]$tot
  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 
 31  62  60  72  71  84  78  71  82  76  89  88  82  82  79  73  93 140 175  95 
 21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 
 31  91  27  25  34  26  92  26  27  24  26  95  28  27  27  26  92  24  33  10 
 41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 
 12  19  11  82  14  10  12  22  13  22  18  15  12  83  12  10  12  12   6  19 
 61  62  63  64  65  66  72 
 25  18  29  88  17   3   1 

[[5]]$grid
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
[51] 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 72</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<p>Book</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>parvovirus<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"D:/OUCRU/serobook/code in the book/Chapter4/VZV-B19-BE.dat"</span>,<span class="at">header=</span>T)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>subset<span class="ot">&lt;-</span>(parvovirus<span class="sc">$</span>age<span class="sc">&gt;</span><span class="fl">0.5</span>)<span class="sc">&amp;</span>(parvovirus<span class="sc">$</span>age<span class="sc">&lt;</span><span class="dv">76</span>)<span class="sc">&amp;</span>(<span class="sc">!</span><span class="fu">is.na</span>(parvovirus<span class="sc">$</span>age))<span class="sc">&amp;!</span><span class="fu">is.na</span>(parvovirus<span class="sc">$</span>parvores)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>parvovirus<span class="ot">&lt;-</span>parvovirus[subset,]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>y<span class="ot">&lt;-</span>parvovirus<span class="sc">$</span>parvores[<span class="fu">order</span>(parvovirus<span class="sc">$</span>age)]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>a<span class="ot">&lt;-</span>parvovirus<span class="sc">$</span>age[<span class="fu">order</span>(parvovirus<span class="sc">$</span>age)]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>s<span class="ot">&lt;-</span>parvovirus<span class="sc">$</span>sex[<span class="fu">order</span>(parvovirus<span class="sc">$</span>age)]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">round</span>(a)))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>neg<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">1</span>,]</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>pos<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">2</span>,]</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>tot<span class="ot">&lt;-</span>neg<span class="sc">+</span>pos</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculating FOI function</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>foi.num<span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="do">##### Hastie and Tibshirani (use BIC to select the smoothing parameter) ######</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>BICf<span class="ot">&lt;-</span><span class="cf">function</span>(fit){<span class="fu">return</span>(fit<span class="sc">$</span>deviance<span class="sc">+</span><span class="fu">log</span>(<span class="fu">length</span>(fit<span class="sc">$</span>y))<span class="sc">*</span>(fit<span class="sc">$</span>nl.df<span class="sc">+</span><span class="dv">2</span>))}</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gam)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>out<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">100</span>)</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>dfi<span class="ot">&lt;-</span><span class="dv">1</span><span class="fl">+0.5</span><span class="sc">*</span>i</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>fit.gam.logit.ht<span class="ot">&lt;-</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">df=</span>dfi),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>fit.gam.cloglog.ht<span class="ot">&lt;-</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">df=</span>dfi),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"cloglog"</span>))</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>out[i,]<span class="ot">&lt;-</span><span class="fu">c</span>(dfi,<span class="fu">BICf</span>(fit.gam.logit.ht),<span class="fu">BICf</span>(fit.gam.cloglog.ht))</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>fit.gam.logit.ht<span class="ot">&lt;-</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">df=</span>out[<span class="fu">which.min</span>(out[,<span class="dv">2</span>]),<span class="dv">1</span>]),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>fit.gam.logit.ht</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
gam(formula = y ~ s(a, df = out[which.min(out[, 2]), 1]), family = binomial(link = "logit"))

Degrees of Freedom: 3070 total; 3065 Residual
Residual Deviance: 3432.623 </code></pre>
</div>
</div>
</div>
</div>
<section id="unit-test-smoothing-splines-function" class="level2">
<h2 class="anchored" data-anchor-id="unit-test-smoothing-splines-function"><strong>Unit test smoothing splines function</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"smoothingsplines returns same result as in the book"</span>, {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  expected_coefs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.13949542</span>, <span class="fl">0.03577971</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  expected_D <span class="ot">&lt;-</span> <span class="fl">3432.623</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> parvovirus</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">smoothing_splines</span>(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age, df<span class="sc">$</span>parvores, </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> <span class="dv">5</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">link=</span><span class="st">"logit"</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  actual_coefs <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">c</span>(</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">1</span>], <span class="co"># intercept</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(model<span class="sc">$</span>info)[<span class="dv">2</span>]</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  actual_D <span class="ot">&lt;-</span> model<span class="sc">$</span>info<span class="sc">$</span>deviance</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_coefs, expected_coefs)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_D, expected_D)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎊</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"find_best_smoothparms returns same result as in the book "</span>, {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  expected_p <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">6</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> parvovirus</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  out1 <span class="ot">&lt;-</span> <span class="fu">find_best_ss_smoothparms</span>(parvovirus<span class="sc">$</span>age,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                        parvovirus<span class="sc">$</span>parvores,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">link =</span> <span class="st">"logit"</span>,<span class="at">upper=</span><span class="dv">100</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  out2 <span class="ot">&lt;-</span> <span class="fu">find_best_ss_smoothparms</span>(parvovirus<span class="sc">$</span>age,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                        parvovirus<span class="sc">$</span>parvores,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">link =</span> <span class="st">"cloglog"</span>,<span class="at">upper=</span><span class="dv">100</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  actual_p <span class="ot">&lt;-</span> <span class="fu">c</span>(out1[<span class="dv">1</span>,<span class="dv">3</span>],out2[<span class="dv">1</span>,<span class="dv">3</span>])</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_p, expected_p)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 😸</code></pre>
</div>
</div>
</section>
<section id="plot-smoothing-splines" class="level2">
<h2 class="anchored" data-anchor-id="plot-smoothing-splines"><strong>Plot smoothing splines</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>plot_smoothing_splines <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  CEX_SCALER <span class="ot">&lt;-</span> <span class="fl">0.02</span> <span class="co"># arbitrary number for better visual</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x<span class="sc">$</span>df, {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">las=</span><span class="dv">1</span>,<span class="at">cex.axis=</span><span class="dv">1</span>,<span class="at">cex.lab=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">mgp=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.5</span>, <span class="dv">0</span>),<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(grid,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>         pos<span class="sc">/</span>tot,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex=</span>CEX_SCALER<span class="sc">*</span>tot,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">pch=</span><span class="dv">1</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab=</span><span class="st">"age"</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylab=</span><span class="st">"seroprevalence"</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(grid)),</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="dv">1</span>))</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(a,x<span class="sc">$</span>sp,<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">col=</span><span class="dv">1</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x<span class="sc">$</span>foi[,<span class="dv">1</span>], x<span class="sc">$</span>foi[,<span class="dv">2</span>], <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="at">at=</span><span class="fu">round</span>(<span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fu">max</span>(x<span class="sc">$</span>foi), <span class="at">length.out=</span><span class="dv">3</span>), <span class="dv">2</span>))</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="st">"force of infection"</span>, <span class="at">las=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_smoothing_splines</span>(outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p style="text-align: center;">
<strong>Note: Do smoothing splines fit bằng GAM của gam package nên dùng predict không được</strong>
</p>
</section>
</section>
<section id="penalize-spline" class="level1">
<h1>8.2.1.2 Penalize spline</h1>
<p>Phần này tác giả dùng function của Eilers and Marx, em có tìm hiểu thì package(mgcv) có function gam với option bs = “ps” tương đương với function này, nhưng làm mọi cách vẫn k ra được kết quả giống package lý do không set up knots được.</p>
<section id="cubic-regression-splines-thin-plate-regression-splines" class="level2">
<h2 class="anchored" data-anchor-id="cubic-regression-splines-thin-plate-regression-splines">Cubic Regression Splines, Thin Plate Regression Splines</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>psfit <span class="ot">&lt;-</span> <span class="cf">function</span>(age,parvores, <span class="at">link =</span> <span class="st">"logit"</span>){</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>parvores[<span class="fu">order</span>(age)]</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>age[<span class="fu">order</span>(age)]</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>smooths  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tp"</span>, <span class="st">"ds"</span>, <span class="st">"cr"</span>, <span class="st">"cs"</span>, <span class="st">"cc"</span>, <span class="st">"bs"</span>, <span class="st">"ps"</span>, <span class="st">"cp"</span>, <span class="st">"re"</span>, <span class="st">"gp"</span>, <span class="st">"ad"</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"sz"</span>, <span class="st">"fs"</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Thin plate regression splines"</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Duchon splines"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Cubic regression splines"</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Shrinkage version of cr"</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Cyclic cubic regression splines"</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>       <span class="st">"B-splines basis"</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>       <span class="st">"P-splines proposed by Eilers and Marx (1996)"</span>,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>       <span class="st">"A cyclic version of a P-spline"</span>,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Random effects"</span>,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Gaussian process smooths"</span>,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Adaptive smoothers"</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Factor smooth interactions"</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Random factor smooth interactions"</span>)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>( <span class="st">"Estimate"</span> <span class="ot">=</span> x<span class="sc">$</span>p.table[<span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Std.Error"</span><span class="ot">=</span> x<span class="sc">$</span>p.table[<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>          <span class="st">"z-value"</span>  <span class="ot">=</span> x<span class="sc">$</span>p.table[<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>quality <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">deviance =</span> <span class="fu">deviance</span>(x),</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">AIC      =</span> <span class="fu">AIC</span>(x),</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">GCV      =</span> x<span class="sc">$</span>gcv.ubre)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>rel <span class="ot">&lt;-</span> smooths <span class="sc">|&gt;</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(<span class="sc">~</span> <span class="fu">p_values</span>(<span class="fu">anova</span>(<span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(a, <span class="at">bs =</span> .x),<span class="fu">binomial</span>(<span class="at">link =</span> link)))))</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>rel1 <span class="ot">&lt;-</span> smooths <span class="sc">|&gt;</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(<span class="sc">~</span> <span class="fu">quality</span>(<span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(a, <span class="at">bs =</span> .x),<span class="fu">binomial</span>(<span class="at">link =</span> link))))</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">Smooth =</span> s), rel,rel1)</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="fu">psfit</span>(parvovirus<span class="sc">$</span>age,parvovirus<span class="sc">$</span>parvores,<span class="at">link =</span> <span class="st">"logit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 7
   Smooth                      Estimate Std.Error `z-value` deviance   AIC   GCV
   &lt;chr&gt;                          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Thin plate regression spli…    0.704    0.0429     16.4     3415. 3434. 0.118
 2 Duchon splines                 0.708    0.0428     16.5     3412. 3432. 0.118
 3 Cubic regression splines       0.707    0.0427     16.6     3421. 3436. 0.119
 4 Shrinkage version of cr        0.707    0.0427     16.6     3421. 3436. 0.119
 5 Cyclic cubic regression sp…    0.718    0.0422     17.0     3448. 3466. 0.128
 6 B-splines basis                0.706    0.0429     16.5     3423. 3441. 0.120
 7 P-splines proposed by Eile…    0.705    0.0429     16.4     3423. 3441. 0.120
 8 A cyclic version of a P-sp…    0.717    0.0427     16.8     3414. 3433. 0.118
 9 Random effects                -0.217    0.0682     -3.19    3679. 3683. 0.199
10 Gaussian process smooths       0.706    0.0429     16.4     3414. 3433. 0.118
11 Adaptive smoothers             0.710    0.0429     16.6     3407. 3425. 0.115
12 Factor smooth interactions     0.704    0.0429     16.4     3415. 3434. 0.118
13 Random factor smooth inter…    0.704    0.0429     16.4     3415. 3434. 0.118</code></pre>
</div>
</div>
</section>
<section id="combine-gam-fit-and-plot" class="level2">
<h2 class="anchored" data-anchor-id="combine-gam-fit-and-plot">Combine gam fit and plot</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>gam_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(age,parvores,<span class="at">s =</span> <span class="st">"bs"</span>,<span class="at">link =</span> <span class="st">"logit"</span>, <span class="at">ci =</span> .<span class="dv">95</span>, <span class="at">m =</span><span class="dv">1</span>){</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>parvores[<span class="fu">order</span>(age)]</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>age[<span class="fu">order</span>(age)]</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">round</span>(a)))</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  neg<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">1</span>,]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  pos<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">2</span>,]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  tot<span class="ot">&lt;-</span>neg<span class="sc">+</span>pos</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate FOI</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  foi.num <span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(y <span class="sc">~</span> <span class="fu">s</span>(a, <span class="at">bs =</span> s),<span class="fu">binomial</span>(<span class="at">link =</span> link))</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  link_inv <span class="ot">&lt;-</span> out<span class="sc">$</span>family<span class="sc">$</span>linkinv</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> out<span class="sc">$</span>model</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dataset) <span class="sc">-</span> <span class="fu">length</span>(out<span class="sc">$</span>coefficients)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  age_range <span class="ot">&lt;-</span> <span class="fu">range</span>(dataset[<span class="dv">2</span>])</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  ages <span class="ot">&lt;-</span> dataset[<span class="dv">2</span>]</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  bs1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(out,<span class="fu">data.frame</span>(<span class="at">a =</span> ages), <span class="at">se.fit =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract</span>(<span class="fu">c</span>(<span class="st">"fit"</span>, <span class="st">"se.fit"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">age =</span> <span class="fu">list</span>(ages), .) <span class="sc">|&gt;</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lwr =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(    p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>           <span class="at">upr =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(<span class="dv">1</span> <span class="sc">-</span> p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>           <span class="at">fit =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit)) <span class="sc">|&gt;</span> </span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span> se.fit)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>  foi1 <span class="ot">&lt;-</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>fit)</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> a, <span class="at">y =</span> bs1<span class="sc">$</span>fit, </span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymin=</span> bs1<span class="sc">$</span>lwr, <span class="at">ymax =</span> bs1<span class="sc">$</span>upr)</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  out.FOI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>fit)<span class="sc">$</span>grid, <span class="at">y =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>fit)<span class="sc">$</span>foi, </span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ymin=</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>lwr)<span class="sc">$</span>foi, <span class="at">ymax =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>upr)<span class="sc">$</span>foi)</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>  fig <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(grid,tot,pos,neg), <span class="fu">aes</span>(<span class="at">x =</span> grid, <span class="at">y =</span> pos<span class="sc">/</span>tot)) <span class="sc">+</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">10</span><span class="sc">*</span>(pos)<span class="sc">/</span><span class="fu">max</span>(tot), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Age"</span>)<span class="sc">+</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(grid)), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.FOI), <span class="at">data=</span>out.FOI, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"hotpink1"</span>,<span class="at">fill =</span> <span class="st">"#f05bcb"</span>,</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>)</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> out.DF<span class="sc">$</span>y</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> out.FOI<span class="sc">$</span>y</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(model,fig))</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">gam_plot</span>(parvovirus<span class="sc">$</span>age, parvovirus<span class="sc">$</span>parvores,<span class="at">s =</span> <span class="st">"tp"</span>, <span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="fu">head</span>(model1[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">head</span>(model1[[<span class="dv">1</span>]]<span class="sc">$</span>foi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 0.04466852 0.04811639 0.05416722 0.05472790 0.05472790 0.05570702

[[2]]
[1] 0.02538786 0.02854959 0.02884110 0.02935600 0.02939593 0.02947610</code></pre>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Package</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>model1[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>Book</strong></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section>
<section id="unit-test-function-gam_plot" class="level2">
<h2 class="anchored" data-anchor-id="unit-test-function-gam_plot"><strong>Unit test function gam_plot</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate FOI</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  foi.num <span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"gam_plot returns same result as in the book"</span>, {</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  expected_sp_summary <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">bs=</span><span class="st">"tp"</span>),<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))<span class="sc">$</span>fitted.values</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  expected_sp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(expected_sp_summary),<span class="fu">mean</span>(expected_sp_summary),<span class="fu">median</span>(expected_sp_summary),<span class="fu">max</span>(expected_sp_summary))</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  expected_foi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.08079526</span>,<span class="fl">0.05375112</span>,<span class="fl">0.06207138</span>,<span class="fl">0.13285975</span>)  </span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> parvovirus</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">gam_plot</span>(parvovirus<span class="sc">$</span>age, parvovirus<span class="sc">$</span>parvores,<span class="at">s =</span> <span class="st">"tp"</span>, <span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  actual_sp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">mean</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">median</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">max</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp))</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  actual_foi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),<span class="fu">mean</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),<span class="fu">median</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),<span class="fu">max</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi))</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_sp, expected_sp)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_foi, expected_foi)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
</div>
</section>
<section id="generalized-linear-mixed-model-framework" class="level2">
<h2 class="anchored" data-anchor-id="generalized-linear-mixed-model-framework"><strong>Generalized Linear Mixed Model Framework</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>glmm_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(age,parvores,<span class="at">s =</span> <span class="st">"bs"</span>,<span class="at">link =</span> <span class="st">"logit"</span>, <span class="at">ci =</span> .<span class="dv">95</span>, <span class="at">m =</span> <span class="dv">1</span>){</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>parvores[<span class="fu">order</span>(age)]</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>age[<span class="fu">order</span>(age)]</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">round</span>(a)))</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  neg<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">1</span>,]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  pos<span class="ot">&lt;-</span><span class="fu">table</span>(y,<span class="fu">round</span>(a))[<span class="dv">2</span>,]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  tot<span class="ot">&lt;-</span>neg<span class="sc">+</span>pos</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate FOI</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  foi.num <span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gamm</span>(y <span class="sc">~</span> <span class="fu">s</span>(a, <span class="at">bs =</span> s ),<span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> link))</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> ci) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  link_inv <span class="ot">&lt;-</span> out<span class="sc">$</span>gam<span class="sc">$</span>family<span class="sc">$</span>linkinv</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">&lt;-</span> out<span class="sc">$</span>gam<span class="sc">$</span>model[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dataset) <span class="sc">-</span> <span class="fu">length</span>(out<span class="sc">$</span>gam<span class="sc">$</span>coefficients)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  age_range <span class="ot">&lt;-</span> <span class="fu">range</span>(dataset[<span class="dv">2</span>])</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  ages <span class="ot">&lt;-</span> dataset[<span class="dv">2</span>]</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>  bs1 <span class="ot">&lt;-</span> <span class="fu">predict.gam</span>(out<span class="sc">$</span>gam,<span class="fu">data.frame</span>(<span class="at">a =</span> ages), <span class="at">se.fit =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract</span>(<span class="fu">c</span>(<span class="st">"fit"</span>, <span class="st">"se.fit"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">age =</span> <span class="fu">list</span>(ages), .) <span class="sc">|&gt;</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lwr =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(    p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">upr =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit <span class="sc">+</span> <span class="fu">qt</span>(<span class="dv">1</span> <span class="sc">-</span> p, n) <span class="sc">*</span> se.fit),</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>           <span class="at">fit =</span> m <span class="sc">*</span> <span class="fu">link_inv</span>(fit)) <span class="sc">|&gt;</span> </span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span> se.fit)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  out.DF <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> a, <span class="at">y =</span> bs1<span class="sc">$</span>fit, </span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymin=</span> bs1<span class="sc">$</span>lwr, <span class="at">ymax =</span> bs1<span class="sc">$</span>upr)</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>  out.FOI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>fit)<span class="sc">$</span>grid, <span class="at">y =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>fit)<span class="sc">$</span>foi, </span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ymin=</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>lwr)<span class="sc">$</span>foi, <span class="at">ymax =</span> <span class="fu">foi.num</span>(a,bs1<span class="sc">$</span>upr)<span class="sc">$</span>foi)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>  fig <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(grid,tot,pos,neg), <span class="fu">aes</span>(<span class="at">x =</span> grid, <span class="at">y =</span> pos<span class="sc">/</span>tot)) <span class="sc">+</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">10</span><span class="sc">*</span>(pos)<span class="sc">/</span><span class="fu">max</span>(tot), <span class="at">shape =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"Seroprevalence"</span>, <span class="at">x=</span><span class="st">"Age"</span>)<span class="sc">+</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(grid)), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.DF), <span class="at">data=</span>out.DF, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"blueviolet"</span>,<span class="at">fill =</span> <span class="st">"royalblue1"</span>,</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes_auto</span>(out.FOI), <span class="at">data=</span>out.FOI, <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">"hotpink1"</span>,<span class="at">fill =</span> <span class="st">"#f05bcb"</span>,</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">lwd =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Seroprevalence"</span>,</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">" Force of infection"</span>)</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> out.DF<span class="sc">$</span>y</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> out.FOI<span class="sc">$</span>y</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(model,fig))</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">glmm_plot</span>(<span class="at">age =</span> parvovirus<span class="sc">$</span>age, <span class="at">parvores =</span> parvovirus<span class="sc">$</span>parvores,<span class="at">s =</span> <span class="st">"tp"</span>, <span class="at">link =</span> <span class="st">"logit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Maximum number of PQL iterations:  20 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="fu">head</span>(model2[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">head</span>(model2[[<span class="dv">1</span>]]<span class="sc">$</span>foi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 0.05740154 0.06114149 0.06760632 0.06819948 0.06819948 0.06923306

[[2]]
[1] 0.02775014 0.03066193 0.03092804 0.03139591 0.03143214 0.03150485</code></pre>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Package</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>model2[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div><div class="column" style="width:50%;">
<p><strong>Book</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
 Maximum number of PQL iterations:  20 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</section>
<section id="unit-test-of-glmm_plot" class="level2">
<h2 class="anchored" data-anchor-id="unit-test-of-glmm_plot"><strong>Unit test of glmm_plot</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"glmm_plot returns same result as in the book"</span>, {</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  expected_sp_summary <span class="ot">&lt;-</span> <span class="fu">predict.gam</span>(<span class="fu">gamm</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">bs=</span><span class="st">"tp"</span>),</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))<span class="sc">$</span>gam, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  expected_foi_summary <span class="ot">&lt;-</span> <span class="fu">foi.num</span>(a,<span class="fu">predict.gam</span>(<span class="fu">gamm</span>(y<span class="sc">~</span><span class="fu">s</span>(a,<span class="at">bs=</span><span class="st">"tp"</span>),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>))<span class="sc">$</span>gam,<span class="at">type=</span><span class="st">"response"</span>))<span class="sc">$</span>foi</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  expected_sp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(expected_sp_summary),<span class="fu">mean</span>(expected_sp_summary),<span class="fu">median</span>(expected_sp_summary),<span class="fu">max</span>(expected_sp_summary))</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  expected_foi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(expected_foi_summary),<span class="fu">mean</span>(expected_foi_summary),<span class="fu">median</span>(expected_foi_summary),<span class="fu">max</span>(expected_foi_summary))  </span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> parvovirus</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">glmm_plot</span>(parvovirus<span class="sc">$</span>age, parvovirus<span class="sc">$</span>parvores,<span class="at">s =</span> <span class="st">"tp"</span>, <span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  actual_sp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">mean</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">median</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp),<span class="fu">max</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>sp))</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  actual_foi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),<span class="fu">mean</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">median</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi),<span class="fu">max</span>(model[[<span class="dv">1</span>]]<span class="sc">$</span>foi))</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_sp, expected_sp)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_foi, expected_foi)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Maximum number of PQL iterations:  20 

 Maximum number of PQL iterations:  20 

 Maximum number of PQL iterations:  20 
Test passed 🎊</code></pre>
</div>
</div>
</section>
<section id="adaptive-spline-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="adaptive-spline-smoothing"><strong>Adaptive Spline Smoothing</strong></h2>
<p>Function AdaptFit bị xóa trên CRAN rồi, có thể dùng mgcv::gam để fit nhưng không có data để unit test</p>
</section>
<section id="chap-9-the-constraint-of-monotonicity" class="level2">
<h2 class="anchored" data-anchor-id="chap-9-the-constraint-of-monotonicity"><strong>Chap 9 The Constraint of Monotonicity</strong></h2>
</section>
<section id="piecewise-constant-forces-of-infection" class="level2">
<h2 class="anchored" data-anchor-id="piecewise-constant-forces-of-infection"><strong>9.2 Piecewise Constant Forces of Infection</strong></h2>
<p>Hiện đang fail</p>
</section>
<section id="keiding1991" class="level2">
<h2 class="anchored" data-anchor-id="keiding1991">9.3.2 Keiding(1991)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>pavit<span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pos=</span>pos,<span class="at">tot=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(pos)))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  gi<span class="ot">&lt;-</span> pos<span class="sc">/</span>tot</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  pai1 <span class="ot">&lt;-</span> pai2 <span class="ot">&lt;-</span> gi</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(pai1)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  ni<span class="ot">&lt;-</span>tot</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(N <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(pai2[i] <span class="sc">&gt;</span> pai2[i <span class="sc">+</span> <span class="dv">1</span>]) {</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>      pool <span class="ot">&lt;-</span> (ni[i]<span class="sc">*</span>pai1[i] <span class="sc">+</span> ni[i<span class="sc">+</span><span class="dv">1</span>]<span class="sc">*</span>pai1[i <span class="sc">+</span> <span class="dv">1</span>])<span class="sc">/</span>(ni[i]<span class="sc">+</span>ni[i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>      pai2[i<span class="sc">:</span>(i <span class="sc">+</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> pool</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>      k <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> (k <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(pai2[j] <span class="sc">&gt;</span> pai2[k]) {</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>          pool<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">sum</span>(ni[j<span class="sc">:</span>k]<span class="sc">*</span>pai1[j<span class="sc">:</span>k])<span class="sc">/</span>(<span class="fu">sum</span>(ni[j<span class="sc">:</span>k]))</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>          pai2[j<span class="sc">:</span>k] <span class="ot">&lt;-</span> pool<span class="fl">.2</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pai1=</span>pai1,<span class="at">pai2=</span>pai2))</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>foi.num<span class="ot">&lt;-</span><span class="cf">function</span>(x,p)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>  grid<span class="ot">&lt;-</span><span class="fu">sort</span>(<span class="fu">unique</span>(x))</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>  pgrid<span class="ot">&lt;-</span>(p[<span class="fu">order</span>(x)])[<span class="fu">duplicated</span>(<span class="fu">sort</span>(x))<span class="sc">==</span>F]</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>  dp<span class="ot">&lt;-</span><span class="fu">diff</span>(pgrid)<span class="sc">/</span><span class="fu">diff</span>(grid)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>  foi<span class="ot">&lt;-</span><span class="fu">approx</span>((grid[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">+</span>grid[<span class="sc">-</span><span class="fu">length</span>(grid)])<span class="sc">/</span><span class="dv">2</span>,dp,grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])<span class="sc">$</span>y<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pgrid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))])</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">grid=</span>grid[<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">length</span>(grid))],<span class="at">foi=</span>foi))</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' Keiding model</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param age the age vector</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pos the positive vector</span></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tot the total vector</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param kernel kernel-based estimate</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param bw bandwidth</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- hav_bg_1964</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a><span class="co">#' model &lt;- keiding_model(df$age,df$pos,df$tot, kernel = "normal", bw = 30)</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a><span class="co">#' plot(model)</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>keiding_model <span class="ot">&lt;-</span> <span class="cf">function</span>(age, pos, tot,<span class="at">kernel =</span><span class="st">"normal"</span>, bw){</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(age)</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">pavit</span>(<span class="at">pos=</span>pos,<span class="at">tot=</span>tot)</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>  foi.k1<span class="ot">&lt;-</span><span class="fu">foi.num</span>(grid,xx<span class="sc">$</span>pai2)<span class="sc">$</span>foi</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>  foi.k1[<span class="fu">is.na</span>(foi.k1)]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>  foi.k1[foi.k1<span class="sc">&gt;</span><span class="dv">10</span>]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>  age.k1<span class="ot">&lt;-</span><span class="fu">foi.num</span>(grid,xx<span class="sc">$</span>pai2)<span class="sc">$</span>grid</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>  fit.k1<span class="ot">&lt;-</span> <span class="fu">ksmooth</span>(age.k1,foi.k1,<span class="at">kernel=</span>kernel,<span class="at">bandwidth=</span>bw,<span class="at">n.points=</span><span class="fu">length</span>(age.k1))</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>age <span class="ot">&lt;-</span> fit.k1<span class="sc">$</span>x</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> fit.k1<span class="sc">$</span>y</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">cumsum</span>(<span class="fu">c</span>(age.k1[<span class="dv">1</span>],<span class="fu">diff</span>(age.k1))<span class="sc">*</span>model<span class="sc">$</span>foi))</span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot=</span>tot,<span class="at">grid =</span> grid)</span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"keiding_model"</span></span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(serosv)</span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keiding_model</span>(df<span class="sc">$</span>age,df<span class="sc">$</span>pos,df<span class="sc">$</span>tot, <span class="at">kernel =</span> <span class="st">"normal"</span>, <span class="at">bw =</span> <span class="dv">30</span>)</span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$age
 [1]  2.0000  3.0125  4.0250  5.0375  6.0500  7.0625  8.0750  9.0875 10.1000
[10] 11.1125 12.1250 13.1375 14.1500 15.1625 16.1750 17.1875 18.2000 19.2125
[19] 20.2250 21.2375 22.2500 23.2625 24.2750 25.2875 26.3000 27.3125 28.3250
[28] 29.3375 30.3500 31.3625 32.3750 33.3875 34.4000 35.4125 36.4250 37.4375
[37] 38.4500 39.4625 40.4750 41.4875 42.5000 43.5125 44.5250 45.5375 46.5500
[46] 47.5625 48.5750 49.5875 50.6000 51.6125 52.6250 53.6375 54.6500 55.6625
[55] 56.6750 57.6875 58.7000 59.7125 60.7250 61.7375 62.7500 63.7625 64.7750
[64] 65.7875 66.8000 67.8125 68.8250 69.8375 70.8500 71.8625 72.8750 73.8875
[73] 74.9000 75.9125 76.9250 77.9375 78.9500 79.9625 80.9750 81.9875 83.0000

$foi
 [1] 0.03448694 0.03501846 0.03562761 0.03631591 0.03708419 0.03793256
 [7] 0.03886042 0.03986643 0.04094858 0.04210426 0.04333037 0.04462342
[13] 0.04597970 0.04739544 0.04886690 0.05039055 0.05196624 0.05359094
[19] 0.05525597 0.05696227 0.05870694 0.06048644 0.06229616 0.06413790
[25] 0.06599061 0.06785033 0.06970172 0.07152870 0.07331112 0.07502561
[31] 0.07664602 0.07814396 0.07948976 0.08065350 0.08160628 0.08232159
[37] 0.08277660 0.08295355 0.08284218 0.08243709 0.08174149 0.08076648
[43] 0.07953085 0.07806058 0.07638864 0.07455015 0.07258610 0.07054025
[49] 0.06845374 0.06636604 0.06431372 0.06232853 0.06043599 0.05865467
[55] 0.05699600 0.05546415 0.05405642 0.05276397 0.05157185 0.05046314
[61] 0.04941852 0.04841314 0.04742593 0.04643763 0.04542886 0.04438489
[67] 0.04329153 0.04214023 0.04092468 0.03964495 0.03830585 0.03690961
[73] 0.03546341 0.03397634 0.03245855 0.03092095 0.02937461 0.02782659
[79] 0.02628853 0.02478159 0.02330453

$sp
 [1] 0.06664893 0.09876779 0.13031129 0.16132822 0.19186006 0.22194075
 [7] 0.25159651 0.28084578 0.30969934 0.33816056 0.36622588 0.39388533
[13] 0.42112331 0.44791940 0.47424930 0.50008574 0.52540094 0.55016564
[19] 0.57434743 0.59791593 0.62084153 0.64309565 0.66465104 0.68548438
[25] 0.70556945 0.72488400 0.74340702 0.76111975 0.77800579 0.79405160
[31] 0.80924695 0.82358561 0.83706588 0.84969111 0.86147010 0.87241733
[37] 0.88255291 0.89190241 0.90049656 0.90837033 0.91556233 0.92211393
[43] 0.92806835 0.93346982 0.93836271 0.94279067 0.94679614 0.95041985
[49] 0.95370024 0.95667322 0.95937202 0.96182700 0.96406569 0.96611278
[55] 0.96799021 0.96971726 0.97131078 0.97278530 0.97415323 0.97542518
[61] 0.97661011 0.97771551 0.97874771 0.97971205 0.98061309 0.98145476
[67] 0.98224048 0.98297332 0.98365606 0.98490193 0.98546934 0.98599588
[73] 0.98648381 0.98693533 0.98735258 0.98773766 0.98809263 0.98841940
[79] 0.98871987 0.98899598 0.98924945

$df
$df$age
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
[51] 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 72 73 74 75 76
[76] 77 78 79 80 81 82 83 86

$df$pos
 [1]  3  3  3  4  7  4  3  4  7  8  2  3  2  0  5 13  1  3 15 22 15  7  8  7 12
[26]  5 10 15  9  9  9  8  9  8  9 13  6 15 11  6  8 13  7  5  7  9  9 22  6 10
[51]  6 13  8  7 13 11  8  8  9 13  5  5  5  5 10  8  4  5  4  8  9  1  4  7  6
[76]  2  3  2  4  1  1  2  1

$df$tot
 [1] 16 15 16 13 12 15 12 11 10 15  7  7 11  1 16 41  2  6 32 37 24 10 10 11 15
[26] 10 13 19 12  9 14 10 11  9 14 14  7 16 13  8  8 14 10  5  7  9  9 22  7 10
[51]  6 14  8  7 13 11  8  8 10 16  5  6  5  5 10  8  4  5  5  8  9  1  4  7  6
[76]  2  3  2  4  1  1  2  1

$df$grid
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
[51] 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 72 73 74 75 76
[76] 77 78 79 80 81 82 83 86


attr(,"class")
[1] "keiding_model"</code></pre>
</div>
</div>
</section>
<section id="plot-keiding-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-keiding-model"><strong>Plot Keiding Model</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' plot() overloading Keiding model</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x the keiding model object.</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... arbitrary params</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>plot.keiding_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  CEX_SCALER <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># arbitrary number for better visual</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x<span class="sc">$</span>df, {</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">las=</span><span class="dv">1</span>,<span class="at">cex.axis=</span><span class="dv">1</span>,<span class="at">cex.lab=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">mgp=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.5</span>, <span class="dv">0</span>),<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>))</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      grid,</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>      pos<span class="sc">/</span>tot,</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex=</span>CEX_SCALER<span class="sc">*</span>tot<span class="sc">/</span><span class="fu">max</span>(tot),</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"age"</span>, <span class="at">ylab=</span><span class="st">"seroprevalence"</span>,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x<span class="sc">$</span>age, x<span class="sc">$</span>sp, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x<span class="sc">$</span>age, x<span class="sc">$</span>foi, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="at">at=</span><span class="fu">round</span>(<span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fu">max</span>(x<span class="sc">$</span>foi), <span class="at">length.out=</span><span class="dv">3</span>), <span class="dv">2</span>))</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="st">"force of infection"</span>, <span class="at">las=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Note</strong>: Keiding model ước tính FOI trước theo monotonicity rồi từ FOI mới tính ra SP nên không dùng function predict cho SP được</p>
</section>
<section id="unit-test-keiding-model" class="level2">
<h2 class="anchored" data-anchor-id="unit-test-keiding-model"><strong>Unit test Keiding model</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"keiding_model returns expected results"</span>, {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  expected_foi_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.02330453</span>, <span class="fl">0.05276397</span>, <span class="fl">0.05504527</span>, <span class="fl">0.08295355</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  expected_sp_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.06664893</span>, <span class="fl">0.9155623</span>, <span class="fl">0.7704096</span>, <span class="fl">0.9892495</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">keiding_model</span>(</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>age,df<span class="sc">$</span>pos,df<span class="sc">$</span>tot, </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel =</span> <span class="st">"normal"</span>, <span class="at">bw =</span> <span class="dv">30</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  actual_foi_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(model<span class="sc">$</span>foi), <span class="fu">median</span>(model<span class="sc">$</span>foi), <span class="fu">mean</span>(model<span class="sc">$</span>foi), <span class="fu">max</span>(model<span class="sc">$</span>foi)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  actual_sp_summary  <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(model<span class="sc">$</span>sp), <span class="fu">median</span>(model<span class="sc">$</span>sp), <span class="fu">mean</span>(model<span class="sc">$</span>sp), <span class="fu">max</span>(model<span class="sc">$</span>sp)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_foi_summary, expected_foi_summary, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_sp_summary, expected_sp_summary, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🥇</code></pre>
</div>
</div>
</section>
<section id="smooth-then-constraint-model" class="level2">
<h2 class="anchored" data-anchor-id="smooth-then-constraint-model"><strong>Smooth then constraint model</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(locfit)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>pavit<span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pos=</span>pos,<span class="at">tot=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(pos)))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  gi<span class="ot">&lt;-</span> pos<span class="sc">/</span>tot</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  pai1 <span class="ot">&lt;-</span> pai2 <span class="ot">&lt;-</span> gi</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fu">length</span>(pai1)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  ni<span class="ot">&lt;-</span>tot</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(N <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(pai2[i] <span class="sc">&gt;</span> pai2[i <span class="sc">+</span> <span class="dv">1</span>]) {</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>      pool <span class="ot">&lt;-</span> (ni[i]<span class="sc">*</span>pai1[i] <span class="sc">+</span> ni[i<span class="sc">+</span><span class="dv">1</span>]<span class="sc">*</span>pai1[i <span class="sc">+</span> <span class="dv">1</span>])<span class="sc">/</span>(ni[i]<span class="sc">+</span>ni[i<span class="sc">+</span><span class="dv">1</span>])</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>      pai2[i<span class="sc">:</span>(i <span class="sc">+</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> pool</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>      k <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> (k <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(pai2[j] <span class="sc">&gt;</span> pai2[k]) {</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>          pool<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">sum</span>(ni[j<span class="sc">:</span>k]<span class="sc">*</span>pai1[j<span class="sc">:</span>k])<span class="sc">/</span>(<span class="fu">sum</span>(ni[j<span class="sc">:</span>k]))</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>          pai2[j<span class="sc">:</span>k] <span class="ot">&lt;-</span> pool<span class="fl">.2</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pai1=</span>pai1,<span class="at">pai2=</span>pai2))</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' Returns the optimal smoothing parameter of GCV  </span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' Refers to section 9.3.3.</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param age the age vector</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pos the positive vector</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tot the total vector</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alphagrid a alpha sequence</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param family family of gcvplot. Default to "binomal"</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param deg degree of gcvplot</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- hav_bg_1964</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' find_the_min_alpha(df$age,df$pos,df$tot,</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="co">#'            seq(0.2,2, by=0.05),family = "binomial", deg =2)</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>find_the_min_alpha <span class="ot">&lt;-</span> <span class="cf">function</span>(age,pos,tot,alphagrid, <span class="at">family =</span> <span class="st">"binomial"</span>,deg){</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>  neg <span class="ot">&lt;-</span> tot <span class="sc">-</span> pos </span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">rep</span>(age,pos),<span class="fu">rep</span>(age,neg))</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(age)),pos),<span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(age)),neg))</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>  gcvp<span class="ot">&lt;-</span><span class="fu">gcvplot</span>(y<span class="sc">~</span>a,<span class="at">family=</span><span class="st">"binomial"</span>,<span class="at">alpha=</span> alphagrid,<span class="at">deg =</span> deg)</span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>  alpha<span class="ot">&lt;-</span>alphagrid[<span class="fu">which.min</span>(gcvp<span class="sc">$</span>values)]</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>  alpha</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a><span class="co">#' A Smooth then constrain model</span></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param age the age vector</span></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pos the positive vector</span></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tot the total vector</span></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param alpha alpha of local fit</span></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param family family of local fit</span></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- hav_bg_1964</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a><span class="co">#' model &lt;- stc(df$age,df$pos,df$tot,</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a><span class="co">#'             alpha = 0.35,family = "binomial")</span></span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>stc <span class="ot">&lt;-</span> <span class="cf">function</span>(age,pos,tot,alpha,<span class="at">family =</span> <span class="st">"binomial"</span>){</span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>  neg <span class="ot">&lt;-</span> tot <span class="sc">-</span> pos</span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">sort</span>(age)</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">rep</span>(age,pos),<span class="fu">rep</span>(age,neg))</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(age)),pos),<span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(age)),neg))</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span>y[<span class="fu">order</span>(a)]</span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>a[<span class="fu">order</span>(a)]</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>  lpfit1 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(y<span class="sc">~</span>a,<span class="at">family=</span> family ,<span class="at">alpha=</span>alpha)</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>  lpfitd1 <span class="ot">&lt;-</span> <span class="fu">locfit</span>(y<span class="sc">~</span>a,<span class="at">deriv=</span><span class="dv">1</span>,<span class="at">family=</span> family,<span class="at">alpha=</span>alpha)</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>  lpfoi1 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(lpfitd1)<span class="sc">*</span><span class="fu">fitted</span>(lpfit1)</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>sp <span class="ot">&lt;-</span> <span class="fu">pavit</span>(<span class="at">pos=</span><span class="fu">fitted</span>(lpfit1))<span class="sc">$</span>pai2</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>  lpfoi2 <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">cbind</span>(<span class="dv">0</span>,<span class="fu">fitted</span>(lpfitd1)),<span class="dv">1</span>,max)<span class="sc">*</span>model<span class="sc">$</span>sp</span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>foi <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">cbind</span>(<span class="dv">0</span>,lpfoi2),<span class="dv">1</span>,max)</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age=</span>age, <span class="at">pos=</span>pos, <span class="at">tot =</span> tot, <span class="at">grid =</span> grid ,<span class="at">a=</span>a )</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(model) <span class="ot">&lt;-</span> <span class="st">"smooth_then_constrain_model"</span></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">stc</span>(df<span class="sc">$</span>age,df<span class="sc">$</span>pos,df<span class="sc">$</span>tot,</span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.35</span>,<span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$sp
  [1] 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335
  [8] 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335 0.1736335
 [15] 0.1736335 0.1736335 0.2149586 0.2149586 0.2149586 0.2149586 0.2149586
 [22] 0.2149586 0.2149586 0.2149586 0.2149586 0.2149586 0.2149586 0.2149586
 [29] 0.2149586 0.2149586 0.2149586 0.2565993 0.2565993 0.2565993 0.2565993
 [36] 0.2565993 0.2565993 0.2565993 0.2565993 0.2565993 0.2565993 0.2565993
 [43] 0.2565993 0.2565993 0.2565993 0.2565993 0.2565993 0.2963602 0.2963602
 [50] 0.2963602 0.2963602 0.2963602 0.2963602 0.2963602 0.2963602 0.2963602
 [57] 0.2963602 0.2963602 0.2963602 0.2963602 0.3323622 0.3323622 0.3323622
 [64] 0.3323622 0.3323622 0.3323622 0.3323622 0.3323622 0.3323622 0.3323622
 [71] 0.3323622 0.3323622 0.3631954 0.3631954 0.3631954 0.3631954 0.3631954
 [78] 0.3631954 0.3631954 0.3631954 0.3631954 0.3631954 0.3631954 0.3631954
 [85] 0.3631954 0.3631954 0.3631954 0.3641736 0.3641736 0.3641736 0.3641736
 [92] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
 [99] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[106] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[113] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[120] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[127] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[134] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[141] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[148] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[155] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[162] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[169] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[176] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[183] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[190] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[197] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[204] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[211] 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736 0.3641736
[218] 0.3641736 0.3751780 0.3751780 0.4216146 0.4216146 0.4216146 0.4216146
[225] 0.4216146 0.4216146 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866
[232] 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866
[239] 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866
[246] 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866
[253] 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.4825866 0.5488385
[260] 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385
[267] 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385
[274] 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385
[281] 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385
[288] 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385 0.5488385
[295] 0.5488385 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396
[302] 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396
[309] 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396 0.6100396
[316] 0.6100396 0.6100396 0.6100396 0.6100396 0.6573397 0.6573397 0.6573397
[323] 0.6573397 0.6573397 0.6573397 0.6573397 0.6573397 0.6573397 0.6573397
[330] 0.6881997 0.6881997 0.6881997 0.6881997 0.6881997 0.6881997 0.6881997
[337] 0.6881997 0.6881997 0.6881997 0.7105668 0.7105668 0.7105668 0.7105668
[344] 0.7105668 0.7105668 0.7105668 0.7105668 0.7105668 0.7105668 0.7105668
[351] 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391
[358] 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391 0.7272391
[365] 0.7272391 0.7403408 0.7403408 0.7403408 0.7403408 0.7403408 0.7403408
[372] 0.7403408 0.7403408 0.7403408 0.7403408 0.7517267 0.7517267 0.7517267
[379] 0.7517267 0.7517267 0.7517267 0.7517267 0.7517267 0.7517267 0.7517267
[386] 0.7517267 0.7517267 0.7517267 0.7626594 0.7626594 0.7626594 0.7626594
[393] 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594
[400] 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594 0.7626594
[407] 0.7626594 0.7716180 0.7716180 0.7716180 0.7716180 0.7716180 0.7716180
[414] 0.7716180 0.7716180 0.7716180 0.7716180 0.7716180 0.7716180 0.7792654
[421] 0.7792654 0.7792654 0.7792654 0.7792654 0.7792654 0.7792654 0.7792654
[428] 0.7792654 0.7867672 0.7867672 0.7867672 0.7867672 0.7867672 0.7867672
[435] 0.7867672 0.7867672 0.7867672 0.7867672 0.7867672 0.7867672 0.7867672
[442] 0.7867672 0.7951760 0.7951760 0.7951760 0.7951760 0.7951760 0.7951760
[449] 0.7951760 0.7951760 0.7951760 0.7951760 0.8053628 0.8053628 0.8053628
[456] 0.8053628 0.8053628 0.8053628 0.8053628 0.8053628 0.8053628 0.8053628
[463] 0.8053628 0.8146952 0.8146952 0.8146952 0.8146952 0.8146952 0.8146952
[470] 0.8146952 0.8146952 0.8146952 0.8225372 0.8225372 0.8225372 0.8225372
[477] 0.8225372 0.8225372 0.8225372 0.8225372 0.8225372 0.8225372 0.8225372
[484] 0.8225372 0.8225372 0.8225372 0.8304715 0.8304715 0.8304715 0.8304715
[491] 0.8304715 0.8304715 0.8304715 0.8304715 0.8304715 0.8304715 0.8304715
[498] 0.8304715 0.8304715 0.8304715 0.8398600 0.8398600 0.8398600 0.8398600
[505] 0.8398600 0.8398600 0.8398600 0.8517800 0.8517800 0.8517800 0.8517800
[512] 0.8517800 0.8517800 0.8517800 0.8517800 0.8517800 0.8517800 0.8517800
[519] 0.8517800 0.8517800 0.8517800 0.8517800 0.8517800 0.8662300 0.8662300
[526] 0.8662300 0.8662300 0.8662300 0.8662300 0.8662300 0.8662300 0.8662300
[533] 0.8662300 0.8662300 0.8662300 0.8662300 0.8814192 0.8814192 0.8814192
[540] 0.8814192 0.8814192 0.8814192 0.8814192 0.8814192 0.8962912 0.8962912
[547] 0.8962912 0.8962912 0.8962912 0.8962912 0.8962912 0.8962912 0.9100930
[554] 0.9100930 0.9100930 0.9100930 0.9100930 0.9100930 0.9100930 0.9100930
[561] 0.9100930 0.9100930 0.9100930 0.9100930 0.9100930 0.9100930 0.9223522
[568] 0.9223522 0.9223522 0.9223522 0.9223522 0.9223522 0.9223522 0.9223522
[575] 0.9223522 0.9223522 0.9328468 0.9328468 0.9328468 0.9328468 0.9328468
[582] 0.9416370 0.9416370 0.9416370 0.9416370 0.9416370 0.9416370 0.9416370
[589] 0.9488987 0.9488987 0.9488987 0.9488987 0.9488987 0.9488987 0.9488987
[596] 0.9488987 0.9488987 0.9548104 0.9548104 0.9548104 0.9548104 0.9548104
[603] 0.9548104 0.9548104 0.9548104 0.9548104 0.9591886 0.9591886 0.9591886
[610] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[617] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[624] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[631] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[638] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[645] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[652] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[659] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[666] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[673] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[680] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[687] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[694] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[701] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[708] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[715] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[722] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[729] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[736] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[743] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[750] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[757] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[764] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[771] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[778] 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886 0.9591886
[785] 0.9591886 0.9651783 0.9651783 0.9651783 0.9651783 0.9722753 0.9722753
[792] 0.9722753 0.9722753 0.9722753 0.9787546 0.9787546 0.9787546 0.9787546
[799] 0.9787546 0.9843251 0.9843251 0.9843251 0.9843251 0.9843251 0.9843251
[806] 0.9843251 0.9843251 0.9923670 0.9923670 0.9923670 0.9923670 0.9923670
[813] 0.9923670 0.9923670 0.9923670 0.9923670 0.9949548 0.9967804 0.9967804
[820] 0.9967804 0.9967804 0.9980146 0.9980146 0.9980146 0.9980146 0.9980146
[827] 0.9980146 0.9980146 0.9988186 0.9988186 0.9988186 0.9988186 0.9988186
[834] 0.9988186 0.9993267 0.9993267 0.9996321 0.9996321 0.9996321 0.9998070
[841] 0.9998070 0.9999027 0.9999027 0.9999027 0.9999027 0.9999528 0.9999779
[848] 0.9999900 0.9999900 0.9999992

$foi
  [1] 0.048902834 0.048902834 0.048902834 0.048902834 0.048902834 0.048902834
  [7] 0.048902834 0.048902834 0.048902834 0.048902834 0.048902834 0.048902834
 [13] 0.048902834 0.048902834 0.048902834 0.048902834 0.053679467 0.053679467
 [19] 0.053679467 0.053679467 0.053679467 0.053679467 0.053679467 0.053679467
 [25] 0.053679467 0.053679467 0.053679467 0.053679467 0.053679467 0.053679467
 [31] 0.053679467 0.055509833 0.055509833 0.055509833 0.055509833 0.055509833
 [37] 0.055509833 0.055509833 0.055509833 0.055509833 0.055509833 0.055509833
 [43] 0.055509833 0.055509833 0.055509833 0.055509833 0.055509833 0.054153338
 [49] 0.054153338 0.054153338 0.054153338 0.054153338 0.054153338 0.054153338
 [55] 0.054153338 0.054153338 0.054153338 0.054153338 0.054153338 0.054153338
 [61] 0.049912665 0.049912665 0.049912665 0.049912665 0.049912665 0.049912665
 [67] 0.049912665 0.049912665 0.049912665 0.049912665 0.049912665 0.049912665
 [73] 0.043557534 0.043557534 0.043557534 0.043557534 0.043557534 0.043557534
 [79] 0.043557534 0.043557534 0.043557534 0.043557534 0.043557534 0.043557534
 [85] 0.043557534 0.043557534 0.043557534 0.032890773 0.032890773 0.032890773
 [91] 0.032890773 0.032890773 0.032890773 0.032890773 0.032890773 0.032890773
 [97] 0.032890773 0.032890773 0.032890773 0.020373036 0.020373036 0.020373036
[103] 0.020373036 0.020373036 0.020373036 0.020373036 0.020373036 0.020373036
[109] 0.020373036 0.020373036 0.008025029 0.008025029 0.008025029 0.008025029
[115] 0.008025029 0.008025029 0.008025029 0.008025029 0.008025029 0.008025029
[121] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[127] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[133] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[139] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[145] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[151] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[157] 0.000000000 0.000000000 0.000000000 0.000000000 0.010036745 0.023574385
[163] 0.023574385 0.023574385 0.023574385 0.023574385 0.023574385 0.023574385
[169] 0.023574385 0.023574385 0.023574385 0.023574385 0.023574385 0.023574385
[175] 0.023574385 0.023574385 0.023574385 0.039252765 0.039252765 0.039252765
[181] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[187] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[193] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[199] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[205] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[211] 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765 0.039252765
[217] 0.039252765 0.039252765 0.057765763 0.057765763 0.078777654 0.078777654
[223] 0.078777654 0.078777654 0.078777654 0.078777654 0.095707864 0.095707864
[229] 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864
[235] 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864
[241] 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864
[247] 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864
[253] 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864 0.095707864
[259] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[265] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[271] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[277] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[283] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[289] 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869 0.106124869
[295] 0.106124869 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772
[301] 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772
[307] 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772
[313] 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772 0.107937772
[319] 0.107937772 0.101236953 0.101236953 0.101236953 0.101236953 0.101236953
[325] 0.101236953 0.101236953 0.101236953 0.101236953 0.101236953 0.089742308
[331] 0.089742308 0.089742308 0.089742308 0.089742308 0.089742308 0.089742308
[337] 0.089742308 0.089742308 0.089742308 0.078416845 0.078416845 0.078416845
[343] 0.078416845 0.078416845 0.078416845 0.078416845 0.078416845 0.078416845
[349] 0.078416845 0.078416845 0.068018679 0.068018679 0.068018679 0.068018679
[355] 0.068018679 0.068018679 0.068018679 0.068018679 0.068018679 0.068018679
[361] 0.068018679 0.068018679 0.068018679 0.068018679 0.068018679 0.058794979
[367] 0.058794979 0.058794979 0.058794979 0.058794979 0.058794979 0.058794979
[373] 0.058794979 0.058794979 0.058794979 0.050753137 0.050753137 0.050753137
[379] 0.050753137 0.050753137 0.050753137 0.050753137 0.050753137 0.050753137
[385] 0.050753137 0.050753137 0.050753137 0.050753137 0.044219126 0.044219126
[391] 0.044219126 0.044219126 0.044219126 0.044219126 0.044219126 0.044219126
[397] 0.044219126 0.044219126 0.044219126 0.044219126 0.044219126 0.044219126
[403] 0.044219126 0.044219126 0.044219126 0.044219126 0.044219126 0.042266272
[409] 0.042266272 0.042266272 0.042266272 0.042266272 0.042266272 0.042266272
[415] 0.042266272 0.042266272 0.042266272 0.042266272 0.042266272 0.044231598
[421] 0.044231598 0.044231598 0.044231598 0.044231598 0.044231598 0.044231598
[427] 0.044231598 0.044231598 0.048476773 0.048476773 0.048476773 0.048476773
[433] 0.048476773 0.048476773 0.048476773 0.048476773 0.048476773 0.048476773
[439] 0.048476773 0.048476773 0.048476773 0.048476773 0.053293675 0.053293675
[445] 0.053293675 0.053293675 0.053293675 0.053293675 0.053293675 0.053293675
[451] 0.053293675 0.053293675 0.056946940 0.056946940 0.056946940 0.056946940
[457] 0.056946940 0.056946940 0.056946940 0.056946940 0.056946940 0.056946940
[463] 0.056946940 0.060817199 0.060817199 0.060817199 0.060817199 0.060817199
[469] 0.060817199 0.060817199 0.060817199 0.060817199 0.066458848 0.066458848
[475] 0.066458848 0.066458848 0.066458848 0.066458848 0.066458848 0.066458848
[481] 0.066458848 0.066458848 0.066458848 0.066458848 0.066458848 0.066458848
[487] 0.073884314 0.073884314 0.073884314 0.073884314 0.073884314 0.073884314
[493] 0.073884314 0.073884314 0.073884314 0.073884314 0.073884314 0.073884314
[499] 0.073884314 0.073884314 0.083124208 0.083124208 0.083124208 0.083124208
[505] 0.083124208 0.083124208 0.083124208 0.094236308 0.094236308 0.094236308
[511] 0.094236308 0.094236308 0.094236308 0.094236308 0.094236308 0.094236308
[517] 0.094236308 0.094236308 0.094236308 0.094236308 0.094236308 0.094236308
[523] 0.094236308 0.105980872 0.105980872 0.105980872 0.105980872 0.105980872
[529] 0.105980872 0.105980872 0.105980872 0.105980872 0.105980872 0.105980872
[535] 0.105980872 0.105980872 0.116058907 0.116058907 0.116058907 0.116058907
[541] 0.116058907 0.116058907 0.116058907 0.116058907 0.124891248 0.124891248
[547] 0.124891248 0.124891248 0.124891248 0.124891248 0.124891248 0.124891248
[553] 0.133026719 0.133026719 0.133026719 0.133026719 0.133026719 0.133026719
[559] 0.133026719 0.133026719 0.133026719 0.133026719 0.133026719 0.133026719
[565] 0.133026719 0.133026719 0.141085979 0.141085979 0.141085979 0.141085979
[571] 0.141085979 0.141085979 0.141085979 0.141085979 0.141085979 0.141085979
[577] 0.148458350 0.148458350 0.148458350 0.148458350 0.148458350 0.148231700
[583] 0.148231700 0.148231700 0.148231700 0.148231700 0.148231700 0.148231700
[589] 0.140303902 0.140303902 0.140303902 0.140303902 0.140303902 0.140303902
[595] 0.140303902 0.140303902 0.140303902 0.126001960 0.126001960 0.126001960
[601] 0.126001960 0.126001960 0.126001960 0.126001960 0.126001960 0.126001960
[607] 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862
[613] 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862
[619] 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862 0.106694862
[625] 0.106694862 0.106694862 0.106694862 0.106694862 0.083607842 0.083607842
[631] 0.083607842 0.083607842 0.083607842 0.083607842 0.083607842 0.058755775
[637] 0.058755775 0.058755775 0.058755775 0.058755775 0.058755775 0.058755775
[643] 0.058755775 0.058755775 0.058755775 0.033575756 0.033575756 0.033575756
[649] 0.033575756 0.033575756 0.033575756 0.009504882 0.009504882 0.009504882
[655] 0.009504882 0.009504882 0.009504882 0.009504882 0.009504882 0.009504882
[661] 0.009504882 0.009504882 0.009504882 0.009504882 0.009504882 0.000000000
[667] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[673] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[679] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[685] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[691] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[697] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[703] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[709] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[715] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[721] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[727] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[733] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[739] 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000
[745] 0.000000000 0.000000000 0.020785523 0.020785523 0.020785523 0.020785523
[751] 0.020785523 0.045743575 0.045743575 0.045743575 0.045743575 0.045743575
[757] 0.045743575 0.072879359 0.072879359 0.072879359 0.072879359 0.072879359
[763] 0.101438068 0.101438068 0.101438068 0.101438068 0.101438068 0.130735263
[769] 0.130735263 0.130735263 0.130735263 0.130735263 0.130735263 0.130735263
[775] 0.130735263 0.130735263 0.130735263 0.161665622 0.161665622 0.161665622
[781] 0.161665622 0.161665622 0.161665622 0.161665622 0.161665622 0.195674797
[787] 0.195674797 0.195674797 0.195674797 0.231875396 0.231875396 0.231875396
[793] 0.231875396 0.231875396 0.269570741 0.269570741 0.269570741 0.269570741
[799] 0.269570741 0.308249062 0.308249062 0.308249062 0.308249062 0.308249062
[805] 0.308249062 0.308249062 0.308249062 0.386534025 0.386534025 0.386534025
[811] 0.386534025 0.386534025 0.386534025 0.386534025 0.386534025 0.386534025
[817] 0.425202796 0.462991840 0.462991840 0.462991840 0.462991840 0.499517687
[823] 0.499517687 0.499517687 0.499517687 0.499517687 0.499517687 0.499517687
[829] 0.534945260 0.534945260 0.534945260 0.534945260 0.534945260 0.534945260
[835] 0.570995576 0.570995576 0.607702629 0.607702629 0.607702629 0.644913988
[841] 0.644913988 0.682473014 0.682473014 0.682473014 0.682473014 0.720217759
[847] 0.757981352 0.795593053 0.795593053 0.905774239

$df
$df$age
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
[51] 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 72 73 74 75 76
[76] 77 78 79 80 81 82 83 86

$df$pos
 [1]  3  3  3  4  7  4  3  4  7  8  2  3  2  0  5 13  1  3 15 22 15  7  8  7 12
[26]  5 10 15  9  9  9  8  9  8  9 13  6 15 11  6  8 13  7  5  7  9  9 22  6 10
[51]  6 13  8  7 13 11  8  8  9 13  5  5  5  5 10  8  4  5  4  8  9  1  4  7  6
[76]  2  3  2  4  1  1  2  1

$df$tot
 [1] 16 15 16 13 12 15 12 11 10 15  7  7 11  1 16 41  2  6 32 37 24 10 10 11 15
[26] 10 13 19 12  9 14 10 11  9 14 14  7 16 13  8  8 14 10  5  7  9  9 22  7 10
[51]  6 14  8  7 13 11  8  8 10 16  5  6  5  5 10  8  4  5  5  8  9  1  4  7  6
[76]  2  3  2  4  1  1  2  1

$df$grid
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
[26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50
[51] 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 72 73 74 75 76
[76] 77 78 79 80 81 82 83 86

$df$a
  [1]  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  2  2  2  2  2  2  2  2  2
 [26]  2  2  2  2  2  2  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  4  4  4
 [51]  4  4  4  4  4  4  4  4  4  4  5  5  5  5  5  5  5  5  5  5  5  5  6  6  6
 [76]  6  6  6  6  6  6  6  6  6  6  6  6  7  7  7  7  7  7  7  7  7  7  7  7  8
[101]  8  8  8  8  8  8  8  8  8  8  9  9  9  9  9  9  9  9  9  9 10 10 10 10 10
[126] 10 10 10 10 10 10 10 10 10 10 11 11 11 11 11 11 11 12 12 12 12 12 12 12 13
[151] 13 13 13 13 13 13 13 13 13 13 14 15 15 15 15 15 15 15 15 15 15 15 15 15 15
[176] 15 15 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16
[201] 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 16 17 17 18 18 18 18 18
[226] 18 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19 19
[251] 19 19 19 19 19 19 19 19 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
[276] 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 21 21 21 21 21
[301] 21 21 21 21 21 21 21 21 21 21 21 21 21 21 21 21 21 21 21 22 22 22 22 22 22
[326] 22 22 22 22 23 23 23 23 23 23 23 23 23 23 24 24 24 24 24 24 24 24 24 24 24
[351] 25 25 25 25 25 25 25 25 25 25 25 25 25 25 25 26 26 26 26 26 26 26 26 26 26
[376] 27 27 27 27 27 27 27 27 27 27 27 27 27 28 28 28 28 28 28 28 28 28 28 28 28
[401] 28 28 28 28 28 28 28 29 29 29 29 29 29 29 29 29 29 29 29 30 30 30 30 30 30
[426] 30 30 30 31 31 31 31 31 31 31 31 31 31 31 31 31 31 32 32 32 32 32 32 32 32
[451] 32 32 33 33 33 33 33 33 33 33 33 33 33 34 34 34 34 34 34 34 34 34 35 35 35
[476] 35 35 35 35 35 35 35 35 35 35 35 36 36 36 36 36 36 36 36 36 36 36 36 36 36
[501] 37 37 37 37 37 37 37 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 39 39
[526] 39 39 39 39 39 39 39 39 39 39 39 40 40 40 40 40 40 40 40 41 41 41 41 41 41
[551] 41 41 42 42 42 42 42 42 42 42 42 42 42 42 42 42 43 43 43 43 43 43 43 43 43
[576] 43 44 44 44 44 44 45 45 45 45 45 45 45 46 46 46 46 46 46 46 46 46 47 47 47
[601] 47 47 47 47 47 47 48 48 48 48 48 48 48 48 48 48 48 48 48 48 48 48 48 48 48
[626] 48 48 48 49 49 49 49 49 49 49 50 50 50 50 50 50 50 50 50 50 51 51 51 51 51
[651] 51 52 52 52 52 52 52 52 52 52 52 52 52 52 52 53 53 53 53 53 53 53 53 54 54
[676] 54 54 54 54 54 55 55 55 55 55 55 55 55 55 55 55 55 55 56 56 56 56 56 56 56
[701] 56 56 56 56 57 57 57 57 57 57 57 57 58 58 58 58 58 58 58 58 59 59 59 59 59
[726] 59 59 59 59 59 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 60 61 61 61 61
[751] 61 62 62 62 62 62 62 63 63 63 63 63 64 64 64 64 64 65 65 65 65 65 65 65 65
[776] 65 65 66 66 66 66 66 66 66 66 67 67 67 67 68 68 68 68 68 69 69 69 69 69 70
[801] 70 70 70 70 70 70 70 72 72 72 72 72 72 72 72 72 73 74 74 74 74 75 75 75 75
[826] 75 75 75 76 76 76 76 76 76 77 77 78 78 78 79 79 80 80 80 80 81 82 83 83 86


attr(,"class")
[1] "smooth_then_constrain_model"</code></pre>
</div>
</div>
</section>
<section id="unit-test" class="level2">
<h2 class="anchored" data-anchor-id="unit-test"><strong>Unit test</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"smooth_then_constrain_model returns expected results"</span>, {</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  expected_foi_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05875577</span>, <span class="fl">0.09195305</span>, <span class="fl">0.9057742</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  expected_sp_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1736335</span>, <span class="fl">0.7792654</span>, <span class="fl">0.6995438</span>, <span class="fl">0.9999992</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> hav_bg_1964</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">stc</span>(df<span class="sc">$</span>age,df<span class="sc">$</span>pos,df<span class="sc">$</span>tot,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.35</span>,<span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  actual_foi_summary <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(model<span class="sc">$</span>foi), <span class="fu">median</span>(model<span class="sc">$</span>foi), <span class="fu">mean</span>(model<span class="sc">$</span>foi), <span class="fu">max</span>(model<span class="sc">$</span>foi)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  actual_sp_summary  <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(model<span class="sc">$</span>sp), <span class="fu">median</span>(model<span class="sc">$</span>sp), <span class="fu">mean</span>(model<span class="sc">$</span>sp), <span class="fu">max</span>(model<span class="sc">$</span>sp)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_foi_summary, expected_foi_summary, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(actual_sp_summary, expected_sp_summary, <span class="at">tolerance=</span><span class="fl">0.000001</span>)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎊</code></pre>
</div>
</div>
</section>
<section id="plot-smooth-then-constraint-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-smooth-then-constraint-model"><strong>plot smooth then constraint model</strong></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' plot() overloading smooth then constrain model</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x the smooth then constrain model object</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... arbitrary params</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>plot.smooth_then_constrain_model <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  CEX_SCALER <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># arbitrary number for better visual</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(x<span class="sc">$</span>df, {</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">las=</span><span class="dv">1</span>,<span class="at">cex.axis=</span><span class="dv">1</span>,<span class="at">cex.lab=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">mgp=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.5</span>, <span class="dv">0</span>),<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>))</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>      grid,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>      pos<span class="sc">/</span>tot,</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex=</span>CEX_SCALER<span class="sc">*</span>tot<span class="sc">/</span><span class="fu">max</span>(tot),</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlab=</span><span class="st">"age"</span>, <span class="at">ylab=</span><span class="st">"seroprevalence"</span>,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(age)), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x<span class="sc">$</span>df<span class="sc">$</span>a,x<span class="sc">$</span>sp,<span class="at">lty=</span><span class="dv">1</span>)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(x<span class="sc">$</span>df<span class="sc">$</span>a,x<span class="sc">$</span>foi,<span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axis</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="at">at=</span><span class="fu">round</span>(<span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fu">max</span>(x<span class="sc">$</span>foi), <span class="at">length.out=</span><span class="dv">3</span>), <span class="dv">2</span>))</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mtext</span>(<span class="at">side=</span><span class="dv">4</span>, <span class="st">"force of infection"</span>, <span class="at">las=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="updated-code_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="p-spline-regression-with-shape-constraints" class="level2">
<h2 class="anchored" data-anchor-id="p-spline-regression-with-shape-constraints">**9.4 P-spline Regression with Shape Constraints</h2>
<p>Dùng function của Eilers và Marx</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>